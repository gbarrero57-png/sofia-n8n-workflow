name: Nightly Full Test Suite

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'

  workflow_dispatch:

jobs:
  full-test-suite:
    name: Complete Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install requests

      - name: Configure credentials
        env:
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
          WORKFLOW_ID: ${{ secrets.WORKFLOW_ID }}
        run: |
          cd testing
          python quick_setup.py "$N8N_API_KEY" "$WORKFLOW_ID"

      - name: Run Phase 1 tests
        run: |
          cd testing
          python test_runner.py --phases phase1 --output phase1_report.txt
        continue-on-error: true

      - name: Run Phase 2 tests
        run: |
          cd testing
          python test_runner.py --phases phase2 --output phase2_report.txt
        continue-on-error: true

      - name: Run Phase 3 tests
        run: |
          cd testing
          python test_runner.py --phases phase3 --output phase3_report.txt
        continue-on-error: true

      - name: Run Phase 4 tests
        run: |
          cd testing
          python test_runner.py --phases phase4 --output phase4_report.txt
        continue-on-error: true

      - name: Run Regression tests
        run: |
          cd testing
          python test_runner.py --phases regression --output regression_report.txt
        continue-on-error: true

      - name: Generate combined report
        run: |
          cd testing
          python test_runner.py --phases all --output nightly_full_report.txt

      - name: Upload all reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-test-reports-${{ github.run_number }}
          path: testing/*_report.txt
          retention-days: 90

      - name: Analyze trends
        run: |
          # Extract metrics for trend analysis
          cd testing

          echo "## Nightly Test Results - $(date +%Y-%m-%d)" > metrics.md
          echo "" >> metrics.md

          for report in phase1_report.txt phase2_report.txt phase3_report.txt phase4_report.txt regression_report.txt; do
            if [ -f "$report" ]; then
              PHASE=$(echo $report | cut -d'_' -f1)
              SUCCESS_RATE=$(grep -oP 'Success Rate:\s+\K\d+\.\d+' "$report" || echo "0.0")
              TOTAL=$(grep -oP 'Total Tests:\s+\K\d+' "$report" || echo "0")
              PASSED=$(grep -oP 'Passed:\s+\K\d+' "$report" || echo "0")
              FAILED=$(grep -oP 'Failed:\s+\K\d+' "$report" || echo "0")

              echo "### $PHASE" >> metrics.md
              echo "- Success Rate: $SUCCESS_RATE%" >> metrics.md
              echo "- Total: $TOTAL | Passed: $PASSED | Failed: $FAILED" >> metrics.md
              echo "" >> metrics.md
            fi
          done

          cat metrics.md

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Nightly Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The nightly test suite has failed.

            **Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Timestamp**: ${new Date().toISOString()}

            Please review the test reports and investigate failures.
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated-test', 'bug', 'high-priority']
            });
