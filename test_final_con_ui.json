{"data":[{"id":"882","finished":false,"mode":"webhook","retryOf":null,"retrySuccessId":null,"status":"error","startedAt":"2026-02-09T18:55:34.690Z","stoppedAt":"2026-02-09T18:55:35.574Z","workflowId":"37SLdWISQLgkHeXk","waitTill":null,"data":{"version":1,"startData":{},"resultData":{"error":{"level":"warning","tags":{},"description":"you must provide a model parameter","timestamp":1770663335569,"context":{"itemIndex":0,"request":{"headers":{"accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","Authorization":"**hidden**","OpenAI-Organization":""},"method":"POST","uri":"https://api.openai.com/v1/chat/completions","gzip":true,"rejectUnauthorized":true,"followRedirect":true,"resolveWithFullResponse":true,"followAllRedirects":true,"timeout":300000,"encoding":null,"json":false,"useStream":true}},"functionality":"regular","name":"NodeApiError","node":{"parameters":{"curlImport":"","method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-call-openai","name":"Llamar OpenAI API","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2576,356],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},"messages":["400 - \"{\\n    \\\"error\\\": {\\n        \\\"message\\\": \\\"you must provide a model parameter\\\",\\n        \\\"type\\\": \\\"invalid_request_error\\\",\\n        \\\"param\\\": null,\\n        \\\"code\\\": null\\n    }\\n}\\n\""],"httpCode":"400","message":"Bad request - please check your parameters","stack":"NodeApiError: Bad request - please check your parameters\n    at ExecuteContext.requestWithAuthentication (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:1513:10)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at ExecuteContext.requestWithAuthentication (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:1813:11)"},"runData":{"Chatwoot Webhook":[{"startTime":1770663334695,"executionIndex":0,"source":[],"hints":[],"executionTime":0,"executionStatus":"success","data":{"main":[[{"json":{"headers":{"host":"workflows.n8n.redsolucionesti.com","user-agent":"curl/8.18.0","content-length":"494","accept":"*/*","content-type":"application/json","x-forwarded-for":"38.253.147.136","x-forwarded-host":"workflows.n8n.redsolucionesti.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"8e1e5b096bb4","x-real-ip":"38.253.147.136","accept-encoding":"gzip"},"params":{},"query":{},"body":{"event":"message_created","content":"Cuánto cuesta una limpieza dental?","message_type":"incoming","created_at":1770656400,"account":{"id":2},"sender":{"id":3,"name":"Paciente Test"},"conversation":{"id":200,"inbox_id":2,"status":"pending","contact_inbox":{"source_id":"test-info-001","inbox":{"channel_type":"Channel::WebWidget"}},"custom_attributes":{"bot_interaction_count":0}}},"webhookUrl":"https://workflows.n8n.redsolucionesti.com/webhook/chatwoot-sofia","executionMode":"production"},"pairedItem":{"item":0}}]]}}],"Validar Input":[{"startTime":1770663334695,"executionIndex":1,"source":[{"previousNode":"Chatwoot Webhook"}],"hints":[],"executionTime":10,"executionStatus":"success","data":{"main":[[{"json":{"message_text":"Cuánto cuesta una limpieza dental?","conversation_id":200,"inbox_id":2,"inbox_id_api":2,"inbox_id_db":3,"clinic_id":"default","contact_phone":"test-info-001","contact_id":3,"account_id":2,"message_type":"incoming","message_timestamp":1770656400,"bot_interaction_count":0,"sender_name":"Paciente Test","conversation_status":"pending","has_contact_inbox":true,"channel_type":"Channel::WebWidget","raw_payload":{"event":"message_created","content":"Cuánto cuesta una limpieza dental?","message_type":"incoming","created_at":1770656400,"account":{"id":2},"sender":{"id":3,"name":"Paciente Test"},"conversation":{"id":200,"inbox_id":2,"status":"pending","contact_inbox":{"source_id":"test-info-001","inbox":{"channel_type":"Channel::WebWidget"}},"custom_attributes":{"bot_interaction_count":0}}}},"pairedItem":{"item":0}}]]}}],"IsUserMessage":[{"startTime":1770663334705,"executionIndex":2,"source":[{"previousNode":"Validar Input"}],"hints":[],"executionTime":1,"executionStatus":"success","data":{"main":[[{"json":{"message_text":"Cuánto cuesta una limpieza dental?","conversation_id":200,"inbox_id":2,"inbox_id_api":2,"inbox_id_db":3,"clinic_id":"default","contact_phone":"test-info-001","contact_id":3,"account_id":2,"message_type":"incoming","message_timestamp":1770656400,"bot_interaction_count":0,"sender_name":"Paciente Test","conversation_status":"pending","has_contact_inbox":true,"channel_type":"Channel::WebWidget","raw_payload":{"event":"message_created","content":"Cuánto cuesta una limpieza dental?","message_type":"incoming","created_at":1770656400,"account":{"id":2},"sender":{"id":3,"name":"Paciente Test"},"conversation":{"id":200,"inbox_id":2,"status":"pending","contact_inbox":{"source_id":"test-info-001","inbox":{"channel_type":"Channel::WebWidget"}},"custom_attributes":{"bot_interaction_count":0}}}},"pairedItem":{"item":0}}],[]]}}],"WhatsApp Safe Check":[{"startTime":1770663334706,"executionIndex":3,"source":[{"previousNode":"IsUserMessage"}],"hints":[],"executionTime":7,"executionStatus":"success","data":{"main":[[{"json":{"message_text":"Cuánto cuesta una limpieza dental?","conversation_id":200,"inbox_id":2,"inbox_id_api":2,"inbox_id_db":3,"clinic_id":"default","contact_phone":"test-info-001","contact_id":3,"account_id":2,"message_type":"incoming","message_timestamp":1770656400,"bot_interaction_count":0,"sender_name":"Paciente Test","conversation_status":"pending","has_contact_inbox":true,"channel_type":"Channel::WebWidget","raw_payload":{"event":"message_created","content":"Cuánto cuesta una limpieza dental?","message_type":"incoming","created_at":1770656400,"account":{"id":2},"sender":{"id":3,"name":"Paciente Test"},"conversation":{"id":200,"inbox_id":2,"status":"pending","contact_inbox":{"source_id":"test-info-001","inbox":{"channel_type":"Channel::WebWidget"}},"custom_attributes":{"bot_interaction_count":0}}},"should_escalate":false,"whatsapp_safe":true,"debug_rule":"NO_ESCALATION_ALL_OK","debug_bot_count":0,"debug_lima_hour":13,"checked_at":"2026-02-09T18:55:34.713Z"},"pairedItem":{"item":0}}]]}}],"OpenAI Chat Model":[{"startTime":1770663334723,"executionTime":643,"executionIndex":5,"executionStatus":"success","source":[{"previousNode":"Clasificador de Intención","previousNodeRun":0}],"data":{"ai_languageModel":[[{"json":{"response":{"generations":[[{"text":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}","generationInfo":{"prompt":0,"completion":0,"finish_reason":"stop","system_fingerprint":"fp_f4ae844694","model_name":"gpt-4o-mini-2024-07-18","service_tier":"default"}}]]},"tokenUsage":{"completionTokens":16,"promptTokens":611,"totalTokens":627}}}]]},"inputOverride":{"ai_languageModel":[[{"json":{"messages":["System: You are an intent classifier for SofIA, a dental clinic virtual assistant.\n\nYour ONLY job is to analyze the patient's message and classify it into ONE category.\n\nRESPOND ONLY with valid JSON in this EXACT format (no explanations):\n{\n  \"intent\": \"CREATE_EVENT\" | \"INFO\" | \"PAYMENT\" | \"HUMAN\",\n  \"confidence\": \"high\" | \"medium\" | \"low\"\n}\n\n== CLASSIFICATION RULES ==\n\n1. INFO (Most common - default for questions)\n   WHEN: Questions about services, prices, hours, location, general info\n   KEYWORDS: cuánto, cuesta, precio, costa, dónde, donde, ubicación, horario, servicios, atienden\n   EXAMPLES:\n     - \"Cuánto cuesta una limpieza dental?\" → INFO (high)\n     - \"Qué horario tienen?\" → INFO (high)\n     - \"Dónde están ubicados?\" → INFO (high)\n     - \"Hacen blanqueamiento?\" → INFO (high)\n     - \"Cuánto sale una consulta?\" → INFO (high)\n   ⭐ PRIORITY: Most questions about the clinic = INFO\n\n2. CREATE_EVENT (Appointments)\n   WHEN: Wants to schedule, reschedule, cancel, or check appointment availability\n   KEYWORDS: cita, agendar, reservar, cambiar cita, cancelar, disponibilidad para cita\n   EXAMPLES:\n     - \"Quiero agendar una cita\" → CREATE_EVENT (high)\n     - \"Tienen disponibilidad mañana?\" → CREATE_EVENT (medium)\n     - \"Necesito cambiar mi cita\" → CREATE_EVENT (high)\n\n3. PAYMENT\n   WHEN: Mentions pending payments, payment methods, already paid\n   KEYWORDS: pagué, pago, transferencia, saldo, debo, ya pagué, cómo pagar\n   EXAMPLES:\n     - \"Ya pagué mi consulta\" → PAYMENT (high)\n     - \"Cómo puedo pagar?\" → PAYMENT (high)\n\n4. HUMAN (Last resort only)\n   WHEN: Medical emergencies, complaints, insurance, invoices\n   KEYWORDS: emergencia, urgencia, dolor fuerte, queja, reclamo, seguro, factura\n   EXAMPLES:\n     - \"Tengo un dolor terrible\" → HUMAN (high)\n     - \"Necesito factura\" → HUMAN (high)\n     - \"Quiero hablar con un humano\" → HUMAN (high)\n\n== DECISION PROCESS ==\n1. Does it ask \"cuánto\", \"precio\", \"cuesta\"? → INFO\n2. Does it mention \"cita\", \"agendar\"? → CREATE_EVENT\n3. Does it mention \"pagué\", \"pago\"? → PAYMENT\n4. Is it an emergency/complaint? → HUMAN\n5. Unclear/greeting? → INFO (low confidence)\n\n⚠️ IMPORTANT: NEVER return HUMAN unless it clearly fits category 4.\n⚠️ Questions about the clinic (prices, services, hours) = INFO\nHuman: {{ $json.message_text }}"],"estimatedTokens":605,"options":{"openai_api_key":{"lc":1,"type":"secret","id":["OPENAI_API_KEY"]},"model":"gpt-4o-mini","max_tokens":50,"temperature":0.1,"timeout":60000,"max_retries":2,"configuration":{"defaultHeaders":{"openai-platform":"org-qkmJQuJ2WnvoIKMr2UJwIJkZ"},"baseURL":"https://api.openai.com/v1","fetchOptions":{}},"model_kwargs":{}}}}]]},"metadata":{"subRun":[{"node":"OpenAI Chat Model","runIndex":0}]}}],"Clasificador de Intención":[{"startTime":1770663334714,"executionIndex":4,"source":[{"previousNode":"WhatsApp Safe Check"}],"hints":[],"executionTime":653,"executionStatus":"success","data":{"main":[[{"json":{"output":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}"},"pairedItem":{"item":0}}]]}}],"Normalizar Intent":[{"startTime":1770663335368,"executionIndex":6,"source":[{"previousNode":"Clasificador de Intención"}],"hints":[],"executionTime":12,"executionStatus":"success","data":{"main":[[{"json":{"output":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}","intent":"INFO","confidence":"low","classified_at":"2026-02-09T18:55:35.378Z","phase":"PHASE_1_TESTING","action":"ESCALATE_TO_HUMAN"},"pairedItem":{"item":0}}]]}}],"Check INFO Intent":[{"startTime":1770663335380,"executionIndex":7,"source":[{"previousNode":"Normalizar Intent"}],"hints":[],"executionTime":1,"executionStatus":"success","data":{"main":[[{"json":{"output":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}","intent":"INFO","confidence":"low","classified_at":"2026-02-09T18:55:35.378Z","phase":"PHASE_1_TESTING","action":"ESCALATE_TO_HUMAN"},"pairedItem":{"item":0}}],[]]}}],"Knowledge Base":[{"startTime":1770663335381,"executionIndex":8,"source":[{"previousNode":"Check INFO Intent"}],"hints":[],"executionTime":7,"executionStatus":"success","data":{"main":[[{"json":{"output":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}","intent":"INFO","confidence":"low","classified_at":"2026-02-09T18:55:35.378Z","phase":"PHASE_1_TESTING","action":"ESCALATE_TO_HUMAN","knowledge_base":{"clinic_info":{"name":"Clínica Dental SofIA Dent (Test)","address":"Av. Principal 123, San Isidro, Lima, Perú","phone":"+51 905 858 566","email":"info@redsolucionesti.com","website":"https://sofia-test.redsolucionesti.com"},"hours":{"weekdays":"Lunes a Viernes: 9:00 AM - 7:00 PM","saturday":"Sábados: 9:00 AM - 2:00 PM","sunday":"Domingos: Cerrado"},"services":[{"name":"Limpieza dental","price_range":"S/ 80 - S/ 150","duration":"30-45 minutos","description":"Limpieza profesional con ultrasonido"},{"name":"Blanqueamiento dental","price_range":"S/ 300 - S/ 500","duration":"60 minutos","description":"Blanqueamiento LED profesional"},{"name":"Consulta general","price_range":"S/ 50 - S/ 80","duration":"30 minutos","description":"Evaluación completa con radiografía panorámica"},{"name":"Ortodoncia","price_range":"S/ 2,500 - S/ 5,000","duration":"12-24 meses","description":"Brackets metálicos o estéticos. Incluye controles mensuales."},{"name":"Extracción simple","price_range":"S/ 100 - S/ 200","duration":"30 minutos","description":"Extracción de piezas dentales no complicadas"},{"name":"Endodoncia (tratamiento de conducto)","price_range":"S/ 300 - S/ 600","duration":"60-90 minutos","description":"Tratamiento de conducto por pieza dental"},{"name":"Implante dental","price_range":"S/ 2,000 - S/ 3,500","duration":"3-6 meses (proceso completo)","description":"Implante de titanio + corona. Requiere evaluación previa."},{"name":"Carillas dentales","price_range":"S/ 400 - S/ 800 por pieza","duration":"2-3 citas","description":"Carillas de resina o porcelana"}],"payment_methods":["Efectivo","Tarjeta de crédito/débito (Visa, Mastercard)","Transferencia bancaria (BCP, Interbank, BBVA)","Yape / Plin"],"faq":[{"question":"¿Tienen estacionamiento?","answer":"Sí, contamos con estacionamiento gratuito para pacientes."},{"question":"¿Atienden emergencias?","answer":"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566."},{"question":"¿Trabajan con seguros?","answer":"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo."},{"question":"¿Primera cita tiene costo?","answer":"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros."}]},"clinic_name":"Clínica Dental SofIA Dent (Test)","knowledge_base_json":"{\n  \"clinic_info\": {\n    \"name\": \"Clínica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Perú\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"Sábados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluación completa con radiografía panorámica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets metálicos o estéticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracción simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracción de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluación previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de crédito/débito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¿Tienen estacionamiento?\",\n      \"answer\": \"Sí, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¿Atienden emergencias?\",\n      \"answer\": \"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¿Trabajan con seguros?\",\n      \"answer\": \"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¿Primera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n}"},"pairedItem":{"item":0}}]]}}],"Preparar Prompt INFO":[{"startTime":1770663335388,"executionIndex":9,"source":[{"previousNode":"Knowledge Base"}],"hints":[],"executionTime":7,"executionStatus":"success","data":{"main":[[{"json":{"output":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}","intent":"INFO","confidence":"low","classified_at":"2026-02-09T18:55:35.378Z","phase":"PHASE_1_TESTING","action":"ESCALATE_TO_HUMAN","knowledge_base":{"clinic_info":{"name":"Clínica Dental SofIA Dent (Test)","address":"Av. Principal 123, San Isidro, Lima, Perú","phone":"+51 905 858 566","email":"info@redsolucionesti.com","website":"https://sofia-test.redsolucionesti.com"},"hours":{"weekdays":"Lunes a Viernes: 9:00 AM - 7:00 PM","saturday":"Sábados: 9:00 AM - 2:00 PM","sunday":"Domingos: Cerrado"},"services":[{"name":"Limpieza dental","price_range":"S/ 80 - S/ 150","duration":"30-45 minutos","description":"Limpieza profesional con ultrasonido"},{"name":"Blanqueamiento dental","price_range":"S/ 300 - S/ 500","duration":"60 minutos","description":"Blanqueamiento LED profesional"},{"name":"Consulta general","price_range":"S/ 50 - S/ 80","duration":"30 minutos","description":"Evaluación completa con radiografía panorámica"},{"name":"Ortodoncia","price_range":"S/ 2,500 - S/ 5,000","duration":"12-24 meses","description":"Brackets metálicos o estéticos. Incluye controles mensuales."},{"name":"Extracción simple","price_range":"S/ 100 - S/ 200","duration":"30 minutos","description":"Extracción de piezas dentales no complicadas"},{"name":"Endodoncia (tratamiento de conducto)","price_range":"S/ 300 - S/ 600","duration":"60-90 minutos","description":"Tratamiento de conducto por pieza dental"},{"name":"Implante dental","price_range":"S/ 2,000 - S/ 3,500","duration":"3-6 meses (proceso completo)","description":"Implante de titanio + corona. Requiere evaluación previa."},{"name":"Carillas dentales","price_range":"S/ 400 - S/ 800 por pieza","duration":"2-3 citas","description":"Carillas de resina o porcelana"}],"payment_methods":["Efectivo","Tarjeta de crédito/débito (Visa, Mastercard)","Transferencia bancaria (BCP, Interbank, BBVA)","Yape / Plin"],"faq":[{"question":"¿Tienen estacionamiento?","answer":"Sí, contamos con estacionamiento gratuito para pacientes."},{"question":"¿Atienden emergencias?","answer":"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566."},{"question":"¿Trabajan con seguros?","answer":"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo."},{"question":"¿Primera cita tiene costo?","answer":"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros."}]},"clinic_name":"Clínica Dental SofIA Dent (Test)","knowledge_base_json":"{\n  \"clinic_info\": {\n    \"name\": \"Clínica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Perú\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"Sábados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluación completa con radiografía panorámica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets metálicos o estéticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracción simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracción de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluación previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de crédito/débito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¿Tienen estacionamiento?\",\n      \"answer\": \"Sí, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¿Atienden emergencias?\",\n      \"answer\": \"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¿Trabajan con seguros?\",\n      \"answer\": \"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¿Primera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n}","system_prompt":"Eres SofIA, asistente virtual de la clínica dental Clínica Dental SofIA Dent (Test).\nTu tarea es responder la pregunta del paciente usando ÚNICAMENTE la información proporcionada.\n\nINFORMACIÓN DE LA CLÍNICA:\n{\n  \"clinic_info\": {\n    \"name\": \"Clínica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Perú\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"Sábados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluación completa con radiografía panorámica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets metálicos o estéticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracción simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracción de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluación previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de crédito/débito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¿Tienen estacionamiento?\",\n      \"answer\": \"Sí, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¿Atienden emergencias?\",\n      \"answer\": \"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¿Trabajan con seguros?\",\n      \"answer\": \"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¿Primera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n}\n\nREGLAS:\n1. Responde SOLO con información que esté en la base de conocimiento\n2. Si la información no está disponible, di EXACTAMENTE: \"No tengo esa información disponible. Te conecto con un agente para ayudarte mejor.\"\n3. Sé amable, conciso y profesional\n4. No inventes precios, horarios ni servicios\n5. Si el paciente pregunta algo que requiere evaluación médica, sugiere agendar una cita\n6. Máximo 3 oraciones\n7. Responde en español\n8. Al final de tu respuesta, siempre pregunta: \"¿Hay algo más en lo que pueda ayudarte?\"","user_prompt":"PREGUNTA DEL PACIENTE:\nundefined"},"pairedItem":{"item":0}}]]}}],"Llamar OpenAI API":[{"startTime":1770663335395,"executionIndex":10,"source":[{"previousNode":"Preparar Prompt INFO"}],"hints":[],"executionTime":179,"executionStatus":"error","error":{"level":"warning","tags":{},"description":"you must provide a model parameter","timestamp":1770663335569,"context":{"itemIndex":0,"request":{"headers":{"accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","Authorization":"**hidden**","OpenAI-Organization":""},"method":"POST","uri":"https://api.openai.com/v1/chat/completions","gzip":true,"rejectUnauthorized":true,"followRedirect":true,"resolveWithFullResponse":true,"followAllRedirects":true,"timeout":300000,"encoding":null,"json":false,"useStream":true}},"functionality":"regular","name":"NodeApiError","node":{"parameters":{"curlImport":"","method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-call-openai","name":"Llamar OpenAI API","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2576,356],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},"messages":["400 - \"{\\n    \\\"error\\\": {\\n        \\\"message\\\": \\\"you must provide a model parameter\\\",\\n        \\\"type\\\": \\\"invalid_request_error\\\",\\n        \\\"param\\\": null,\\n        \\\"code\\\": null\\n    }\\n}\\n\""],"httpCode":"400","message":"Bad request - please check your parameters","stack":"NodeApiError: Bad request - please check your parameters\n    at ExecuteContext.requestWithAuthentication (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:1513:10)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at ExecuteContext.requestWithAuthentication (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_ec37920eb95917b28efaa783206b20f3/node_modules/n8n-core/src/execution-engine/node-execution-context/utils/request-helper-functions.ts:1813:11)"}}]},"lastNodeExecuted":"Llamar OpenAI API"},"executionData":{"contextData":{},"nodeExecutionStack":[{"node":{"parameters":{"curlImport":"","method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-call-openai","name":"Llamar OpenAI API","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2576,356],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},"data":{"main":[[{"json":{"output":"{\n  \"intent\": \"INFO\",\n  \"confidence\": \"low\"\n}","intent":"INFO","confidence":"low","classified_at":"2026-02-09T18:55:35.378Z","phase":"PHASE_1_TESTING","action":"ESCALATE_TO_HUMAN","knowledge_base":{"clinic_info":{"name":"Clínica Dental SofIA Dent (Test)","address":"Av. Principal 123, San Isidro, Lima, Perú","phone":"+51 905 858 566","email":"info@redsolucionesti.com","website":"https://sofia-test.redsolucionesti.com"},"hours":{"weekdays":"Lunes a Viernes: 9:00 AM - 7:00 PM","saturday":"Sábados: 9:00 AM - 2:00 PM","sunday":"Domingos: Cerrado"},"services":[{"name":"Limpieza dental","price_range":"S/ 80 - S/ 150","duration":"30-45 minutos","description":"Limpieza profesional con ultrasonido"},{"name":"Blanqueamiento dental","price_range":"S/ 300 - S/ 500","duration":"60 minutos","description":"Blanqueamiento LED profesional"},{"name":"Consulta general","price_range":"S/ 50 - S/ 80","duration":"30 minutos","description":"Evaluación completa con radiografía panorámica"},{"name":"Ortodoncia","price_range":"S/ 2,500 - S/ 5,000","duration":"12-24 meses","description":"Brackets metálicos o estéticos. Incluye controles mensuales."},{"name":"Extracción simple","price_range":"S/ 100 - S/ 200","duration":"30 minutos","description":"Extracción de piezas dentales no complicadas"},{"name":"Endodoncia (tratamiento de conducto)","price_range":"S/ 300 - S/ 600","duration":"60-90 minutos","description":"Tratamiento de conducto por pieza dental"},{"name":"Implante dental","price_range":"S/ 2,000 - S/ 3,500","duration":"3-6 meses (proceso completo)","description":"Implante de titanio + corona. Requiere evaluación previa."},{"name":"Carillas dentales","price_range":"S/ 400 - S/ 800 por pieza","duration":"2-3 citas","description":"Carillas de resina o porcelana"}],"payment_methods":["Efectivo","Tarjeta de crédito/débito (Visa, Mastercard)","Transferencia bancaria (BCP, Interbank, BBVA)","Yape / Plin"],"faq":[{"question":"¿Tienen estacionamiento?","answer":"Sí, contamos con estacionamiento gratuito para pacientes."},{"question":"¿Atienden emergencias?","answer":"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566."},{"question":"¿Trabajan con seguros?","answer":"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo."},{"question":"¿Primera cita tiene costo?","answer":"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros."}]},"clinic_name":"Clínica Dental SofIA Dent (Test)","knowledge_base_json":"{\n  \"clinic_info\": {\n    \"name\": \"Clínica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Perú\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"Sábados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluación completa con radiografía panorámica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets metálicos o estéticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracción simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracción de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluación previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de crédito/débito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¿Tienen estacionamiento?\",\n      \"answer\": \"Sí, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¿Atienden emergencias?\",\n      \"answer\": \"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¿Trabajan con seguros?\",\n      \"answer\": \"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¿Primera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n}","system_prompt":"Eres SofIA, asistente virtual de la clínica dental Clínica Dental SofIA Dent (Test).\nTu tarea es responder la pregunta del paciente usando ÚNICAMENTE la información proporcionada.\n\nINFORMACIÓN DE LA CLÍNICA:\n{\n  \"clinic_info\": {\n    \"name\": \"Clínica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Perú\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"Sábados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluación completa con radiografía panorámica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets metálicos o estéticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracción simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracción de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluación previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de crédito/débito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¿Tienen estacionamiento?\",\n      \"answer\": \"Sí, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¿Atienden emergencias?\",\n      \"answer\": \"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¿Trabajan con seguros?\",\n      \"answer\": \"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¿Primera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n}\n\nREGLAS:\n1. Responde SOLO con información que esté en la base de conocimiento\n2. Si la información no está disponible, di EXACTAMENTE: \"No tengo esa información disponible. Te conecto con un agente para ayudarte mejor.\"\n3. Sé amable, conciso y profesional\n4. No inventes precios, horarios ni servicios\n5. Si el paciente pregunta algo que requiere evaluación médica, sugiere agendar una cita\n6. Máximo 3 oraciones\n7. Responde en español\n8. Al final de tu respuesta, siempre pregunta: \"¿Hay algo más en lo que pueda ayudarte?\"","user_prompt":"PREGUNTA DEL PACIENTE:\nundefined"},"pairedItem":{"item":0}}]]},"source":{"main":[{"previousNode":"Preparar Prompt INFO"}]}}],"metadata":{"OpenAI Chat Model":[{"subRun":[{"node":"OpenAI Chat Model","runIndex":0}]}]},"waitingExecution":{},"waitingExecutionSource":{},"runtimeData":{"version":1,"establishedAt":1770663334694,"source":"webhook","triggerNode":{"name":"Chatwoot Webhook","type":"n8n-nodes-base.webhook"}}}},"workflowData":{"id":"37SLdWISQLgkHeXk","name":"Sofia","active":true,"activeVersionId":"2765ad9a-6662-4d6c-91d1-a757df9a42cb","isArchived":false,"createdAt":"2026-01-21T18:48:10.157Z","updatedAt":"2026-02-09T18:54:23.837Z","nodes":[{"parameters":{"multipleMethods":false,"httpMethod":"POST","path":"chatwoot-sofia","authentication":"none","responseMode":"responseNode","webhookNotice":"","options":{}},"id":"webhook-chatwoot","name":"Chatwoot Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[208,284],"webhookId":"chatwoot-sofia"},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// ============================================\n// VALIDAR INPUT + DETECTAR CONTACTO NUEVO\n// ============================================\nconst payload = $input.item.json.body || $input.item.json;\n\n// Campos del evento\nconst event = payload.event;\nconst content = payload.content || '';\nconst conversation_id = payload.conversation?.id;\nconst inbox_id = payload.conversation?.inbox_id;\nconst clinic_id = payload.conversation?.custom_attributes?.clinic_id;\nconst patient_id = payload.conversation?.custom_attributes?.patient_id;\nconst contact_phone = payload.conversation?.contact_inbox?.source_id;\nconst contact_id = payload.sender?.id;\nconst channel_type = payload.conversation?.contact_inbox?.inbox?.channel_type;\nconst account_id = payload.account?.id || 2;\nconst message_type = payload.message_type;\nconst created_at = payload.created_at;\n\n// Obtener contador de interacciones bot\nconst bot_count = payload.conversation?.custom_attributes?.bot_interaction_count || 0;\nconst last_bot_message = payload.conversation?.custom_attributes?.last_bot_message_at;\nconst contact_inboxes = payload.conversation?.contact_inbox;\nconst has_contact_inbox = !!contact_inboxes;\n\nreturn [{\n  json: {\n    message_text: (content || '').trim(),\n    conversation_id: conversation_id,\n    inbox_id: inbox_id,\n    inbox_id_api: 2,\n    inbox_id_db: 3,\n    clinic_id: clinic_id || 'default',\n    patient_id: patient_id,\n    contact_phone: contact_phone,\n    contact_id: contact_id,\n    account_id: account_id,\n    message_type: message_type,\n    message_timestamp: created_at,\n    bot_interaction_count: bot_count,\n    last_bot_message_at: last_bot_message,\n    sender_name: payload.sender?.name || 'Paciente',\n    sender_email: payload.sender?.email,\n    conversation_status: payload.conversation?.status,\n    has_contact_inbox: has_contact_inbox,\n    channel_type: channel_type || 'Channel::WebWidget',\n    raw_payload: payload\n  }\n}];\n","notice":""},"id":"code-validate","name":"Validar Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[432,284]},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// ============================================\n// WHATSAPP SAFE RULES - FASE 1\n// ============================================\nconst bot_count = $json.bot_interaction_count || 0;\nconst message_lower = ($json.message_text || '').toLowerCase();\n\n// Regla 1: MÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡ximo 1 interacciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n automÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¡tica en Fase 1\nif (bot_count >= 1) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MAX_INTERACTIONS_PHASE1',\n      debug_rule: 'RULE_1_MAX_INTERACTIONS',\n      debug_bot_count: bot_count,\n      escalation_message: 'Te conecto con un agente de inmediato.'\n    }\n  }];\n}\n\n// Regla 2: Mensaje > 24h\nconst message_age_hours = (Date.now() - ($json.message_timestamp * 1000)) / (1000 * 60 * 60);\nif (message_age_hours > 24) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MESSAGE_TOO_OLD',\n      debug_rule: 'RULE_2_MESSAGE_AGE',\n      debug_age_hours: message_age_hours,\n      escalation_message: 'Te conecto con un agente.'\n    }\n  }];\n}\n\n// Regla 3: Horario comercial (Lima, Peru)\nconst now = new Date();\nconst lima_hour = parseInt(now.toLocaleString('en-US', { \n  timeZone: 'America/Lima', \n  hour: 'numeric', \n  hour12: false \n}));\n\nif (lima_hour < 8 || lima_hour >= 22) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'OUTSIDE_BUSINESS_HOURS',\n      debug_rule: 'RULE_3_HOURS',\n      debug_lima_hour: lima_hour,\n      debug_now: now.toISOString(),\n      escalation_message: 'Gracias por escribirnos. Te responderemos en horario de atenciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n (8am - 10pm).'\n    }\n  }];\n}\n\n// Regla 4: Emergencias\nconst emergency_keywords = [\n  'emergencia', 'urgencia', 'dolor fuerte', 'sangra', 'mucho dolor',\n  'me caÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­', 'golpe', 'accidente', 'no puedo', 'ayuda urgente',\n  'hinchazÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n', 'infecciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n', 'fiebre'\n];\nconst is_emergency = emergency_keywords.some(kw => message_lower.includes(kw));\n\nif (is_emergency) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'EMERGENCY_DETECTED',\n      debug_rule: 'RULE_4_EMERGENCY',\n      escalation_message: 'Detecto que podrÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­as tener una urgencia. Te conecto de inmediato con nuestro equipo.',\n      priority: 'urgent'\n    }\n  }];\n}\n\n// Regla 5: Opt-out\nconst opt_out_keywords = ['detente', 'ya no', 'basta', 'stop', 'cancelar bot', 'agente', 'humano', 'persona'];\nconst wants_opt_out = opt_out_keywords.some(kw => message_lower.includes(kw));\n\nif (wants_opt_out) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'USER_OPT_OUT',\n      debug_rule: 'RULE_5_OPT_OUT',\n      escalation_message: 'Entendido. Te conecto con un agente humano.'\n    }\n  }];\n}\n\n// Todo OK - continuar al clasificador\nreturn [{\n  json: {\n    ...$json,\n    should_escalate: false,\n    whatsapp_safe: true,\n    debug_rule: 'NO_ESCALATION_ALL_OK',\n    debug_bot_count: bot_count,\n    debug_lima_hour: lima_hour,\n    checked_at: new Date().toISOString()\n  }\n}];","notice":""},"id":"code-whatsapp-safe","name":"WhatsApp Safe Check","type":"n8n-nodes-base.code","typeVersion":2,"position":[880,160]},{"parameters":{"aiAgentStarterCallout":"","agent":"toolsAgent","promptType":"define","text":"{{ $json.message_text }}","hasOutputParser":true,"notice":"","options":{"systemMessage":"You are an intent classifier for SofIA, a dental clinic virtual assistant.\n\nYour ONLY job is to analyze the patient's message and classify it into ONE category.\n\nRESPOND ONLY with valid JSON in this EXACT format (no explanations):\n{\n  \"intent\": \"CREATE_EVENT\" | \"INFO\" | \"PAYMENT\" | \"HUMAN\",\n  \"confidence\": \"high\" | \"medium\" | \"low\"\n}\n\n== CLASSIFICATION RULES ==\n\n1. INFO (Most common - default for questions)\n   WHEN: Questions about services, prices, hours, location, general info\n   KEYWORDS: cuánto, cuesta, precio, costa, dónde, donde, ubicación, horario, servicios, atienden\n   EXAMPLES:\n     - \"Cuánto cuesta una limpieza dental?\" → INFO (high)\n     - \"Qué horario tienen?\" → INFO (high)\n     - \"Dónde están ubicados?\" → INFO (high)\n     - \"Hacen blanqueamiento?\" → INFO (high)\n     - \"Cuánto sale una consulta?\" → INFO (high)\n   ⭐ PRIORITY: Most questions about the clinic = INFO\n\n2. CREATE_EVENT (Appointments)\n   WHEN: Wants to schedule, reschedule, cancel, or check appointment availability\n   KEYWORDS: cita, agendar, reservar, cambiar cita, cancelar, disponibilidad para cita\n   EXAMPLES:\n     - \"Quiero agendar una cita\" → CREATE_EVENT (high)\n     - \"Tienen disponibilidad mañana?\" → CREATE_EVENT (medium)\n     - \"Necesito cambiar mi cita\" → CREATE_EVENT (high)\n\n3. PAYMENT\n   WHEN: Mentions pending payments, payment methods, already paid\n   KEYWORDS: pagué, pago, transferencia, saldo, debo, ya pagué, cómo pagar\n   EXAMPLES:\n     - \"Ya pagué mi consulta\" → PAYMENT (high)\n     - \"Cómo puedo pagar?\" → PAYMENT (high)\n\n4. HUMAN (Last resort only)\n   WHEN: Medical emergencies, complaints, insurance, invoices\n   KEYWORDS: emergencia, urgencia, dolor fuerte, queja, reclamo, seguro, factura\n   EXAMPLES:\n     - \"Tengo un dolor terrible\" → HUMAN (high)\n     - \"Necesito factura\" → HUMAN (high)\n     - \"Quiero hablar con un humano\" → HUMAN (high)\n\n== DECISION PROCESS ==\n1. Does it ask \"cuánto\", \"precio\", \"cuesta\"? → INFO\n2. Does it mention \"cita\", \"agendar\"? → CREATE_EVENT\n3. Does it mention \"pagué\", \"pago\"? → PAYMENT\n4. Is it an emergency/complaint? → HUMAN\n5. Unclear/greeting? → INFO (low confidence)\n\n⚠️ IMPORTANT: NEVER return HUMAN unless it clearly fits category 4.\n⚠️ Questions about the clinic (prices, services, hours) = INFO"},"credentials":""},"id":"agent-classifier","name":"Clasificador de Intención","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[1328,284]},{"parameters":{"notice":"","model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{"maxTokens":50,"temperature":0.1}},"id":"openai-model","name":"OpenAI Chat Model","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1400,508],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// ============================================\n// NORMALIZAR OUTPUT DEL CLASIFICADOR\n// ============================================\nlet intent_data = $json.output || $json;\n\nif (typeof intent_data === 'string') {\n  try {\n    intent_data = JSON.parse(intent_data);\n  } catch (e) {\n    const text = intent_data.toLowerCase();\n    if (text.includes('create_event')) {\n      intent_data = { intent: 'CREATE_EVENT', confidence: 'low' };\n    } else if (text.includes('info')) {\n      intent_data = { intent: 'INFO', confidence: 'low' };\n    } else if (text.includes('payment')) {\n      intent_data = { intent: 'PAYMENT', confidence: 'low' };\n    } else {\n      intent_data = { intent: 'HUMAN', confidence: 'low' };\n    }\n  }\n}\n\nlet intent = (intent_data.intent || 'HUMAN').trim().toUpperCase();\nlet confidence = (intent_data.confidence || 'low').toLowerCase();\n\nconst valid_intents = ['CREATE_EVENT', 'INFO', 'PAYMENT', 'HUMAN'];\nif (!valid_intents.includes(intent)) {\n  intent = 'HUMAN';\n  confidence = 'low';\n}\n\nreturn [{\n  json: {\n    ...$json,\n    intent: intent,\n    confidence: confidence,\n    classified_at: new Date().toISOString(),\n    phase: 'PHASE_1_TESTING',\n    action: 'ESCALATE_TO_HUMAN'\n  }\n}];","notice":""},"id":"code-normalize","name":"Normalizar Intent","type":"n8n-nodes-base.code","typeVersion":2,"position":[1680,284]},{"parameters":{"keepOnlySet":false,"values":{"string":[{"name":"escalation_message_final","value":"={{ $json.escalation_message || 'Te conecto con un agente de nuestro equipo.' }}"},{"name":"escalation_reason_final","value":"={{ $json.escalation_reason || 'PHASE_1_' + $json.intent }}"},{"name":"internal_note","value":"=ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸Ãƒâ€šÃ‚Â¤ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Å“ SofIA (Fase 1)\\n\\nIntenciÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n detectada: {{ $json.intent }} ({{ $json.confidence }})\\nRazÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â³n: {{ $json.escalation_reason || 'Testing Fase 1' }}\\nMensaje original: \\\"{{ $json.message_text }}\\\"\\nClÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­nica: {{ $json.clinic_id }}\\nPaciente: {{ $json.patient_id }}"},{"name":"account_id","value":"={{ $json.account_id }}"},{"name":"conversation_id","value":"={{ $json.conversation_id }}"}],"boolean":[{"name":"is_urgent","value":"={{ $json.priority === 'urgent' ? true : false }}"}]},"options":{}},"id":"set-prepare","name":"Preparar Escalado","type":"n8n-nodes-base.set","typeVersion":1,"position":[3472,112]},{"parameters":{"curlImport":"","method":"POST","url":"https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","authentication":"none","provideSslCertificates":false,"sendQuery":false,"sendHeaders":true,"specifyHeaders":"keypair","headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"contentType":"json","specifyBody":"json","jsonBody":"={\n  \"content\": \"{{ $json.escalation_message_final }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}","options":{},"infoMessage":""},"id":"http-send-message","name":"Enviar Mensaje Escalado","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3696,112]},{"parameters":{"curlImport":"","method":"POST","url":"https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","authentication":"none","provideSslCertificates":false,"sendQuery":false,"sendHeaders":true,"specifyHeaders":"keypair","headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"contentType":"json","specifyBody":"json","jsonBody":"={\n  \"content\": \"SofIA Bot - Fase 1\\n\\nIntencion: {{ $json.intent }}\\nConfianza: {{ $json.confidence }}\\nRazon: {{ $json.escalation_reason || \\\"Testing\\\" }}\\nMensaje: {{ $json.message_text }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": true\n}","options":{},"infoMessage":""},"id":"http-note","name":"Crear Nota Interna","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3920,112]},{"parameters":{"curlImport":"","method":"PATCH","url":"https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}","authentication":"none","provideSslCertificates":false,"sendQuery":false,"sendHeaders":true,"specifyHeaders":"keypair","headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"contentType":"json","specifyBody":"json","jsonBody":"={\n  \"custom_attributes\": {\n    \"bot_handled\": true,\n    \"intent_detected\": \"{{ $json.intent }}\",\n    \"confidence\": \"{{ $json.confidence }}\",\n    \"bot_interaction_count\": {{ ($json.bot_interaction_count || 0) + 1 }},\n    \"last_bot_message_at\": \"{{ $now.toISO() }}\",\n    \"escalation_reason\": \"{{ $json.escalation_reason_final }}\",\n    \"sofia_phase\": \"PHASE_1\"\n  }\n}","options":{},"infoMessage":""},"id":"http-attributes","name":"Actualizar Custom Attributes","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[4144,112]},{"parameters":{"generalNotice":"","respondWith":"json","webhookNotice":"","responseBody":"={{ JSON.stringify({ status: 'ok', processed: true, intent: $json.intent, conversation_id: $json.conversation_id }) }}","options":{"responseCode":200}},"id":"respond-webhook","name":"Responder OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[4368,404]},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// ============================================\n// KNOWLEDGE BASE - FASE 2\n// Base de conocimiento estática de la clínica\n// ============================================\n\nconst KNOWLEDGE_BASE = {\n  \"clinic_info\": {\n    \"name\": \"Clínica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Perú\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"Sábados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluación completa con radiografía panorámica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets metálicos o estéticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracción simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracción de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluación previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de crédito/débito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¿Tienen estacionamiento?\",\n      \"answer\": \"Sí, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¿Atienden emergencias?\",\n      \"answer\": \"Sí, atendemos emergencias dentales en horario de atención. Fuera de horario, comunícate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¿Trabajan con seguros?\",\n      \"answer\": \"Trabajamos con Rímac, Pacífico y Mapfre. Consulta cobertura específica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¿Primera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluación tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n};\n\n// Pasar datos al siguiente nodo\nreturn [{\n  json: {\n    ...($json || {}),\n    knowledge_base: KNOWLEDGE_BASE,\n    clinic_name: KNOWLEDGE_BASE.clinic_info.name,\n    knowledge_base_json: JSON.stringify(KNOWLEDGE_BASE, null, 2)\n  }\n}];\n","notice":""},"id":"code-knowledge-base","name":"Knowledge Base","type":"n8n-nodes-base.code","typeVersion":2,"position":[2128,356]},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// Preparar prompt para LLM\nconst knowledge_base_json = $json.knowledge_base_json;\nconst message_text = $json.message_text;\nconst clinic_name = $json.clinic_name;\n\nconst system_prompt = `Eres SofIA, asistente virtual de la clínica dental ${clinic_name}.\nTu tarea es responder la pregunta del paciente usando ÚNICAMENTE la información proporcionada.\n\nINFORMACIÓN DE LA CLÍNICA:\n${knowledge_base_json}\n\nREGLAS:\n1. Responde SOLO con información que esté en la base de conocimiento\n2. Si la información no está disponible, di EXACTAMENTE: \"No tengo esa información disponible. Te conecto con un agente para ayudarte mejor.\"\n3. Sé amable, conciso y profesional\n4. No inventes precios, horarios ni servicios\n5. Si el paciente pregunta algo que requiere evaluación médica, sugiere agendar una cita\n6. Máximo 3 oraciones\n7. Responde en español\n8. Al final de tu respuesta, siempre pregunta: \"¿Hay algo más en lo que pueda ayudarte?\"`;\n\nconst user_prompt = `PREGUNTA DEL PACIENTE:\n${message_text}`;\n\nreturn [{\n  json: {\n    ...($json || {}),\n    system_prompt: system_prompt,\n    user_prompt: user_prompt\n  }\n}];\n","notice":""},"id":"code-prepare-prompt","name":"Preparar Prompt INFO","type":"n8n-nodes-base.code","typeVersion":2,"position":[2352,356]},{"parameters":{"curlImport":"","method":"POST","url":"https://api.openai.com/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-call-openai","name":"Llamar OpenAI API","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2576,356],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// Extraer respuesta del LLM\nconst response = $json;\n\n// La respuesta de OpenAI viene en response.choices[0].message.content\nconst llm_response = response.choices?.[0]?.message?.content || '';\n\nreturn [{\n  json: {\n    ...($input.all()[0].json || {}),  // Mantener todos los datos anteriores\n    llm_response: llm_response.trim()\n  }\n}];\n","notice":""},"id":"code-extract-response","name":"Extraer Respuesta LLM","type":"n8n-nodes-base.code","typeVersion":2,"position":[2800,356]},{"parameters":{"mode":"runOnceForAllItems","language":"javaScript","jsCode":"// ============================================\n// VALIDACION ANTI-ALUCINACION\n// ============================================\n\nconst llm_response = $json.llm_response || '';\n\n// Flags de validación\nlet should_escalate = false;\nlet escalation_reason = '';\n\n// Regla 1: Respuesta muy larga (>500 chars)\nif (llm_response.length > 500) {\n  should_escalate = true;\n  escalation_reason = 'Respuesta LLM muy larga (>500 chars)';\n}\n\n// Regla 2: LLM dice que no tiene información\nconst no_info_keywords = [\n  'no tengo esa información',\n  'no dispongo',\n  'no cuento con',\n  'no tengo información',\n  'no está disponible',\n  'te conecto con un agente'\n];\n\nfor (const keyword of no_info_keywords) {\n  if (llm_response.toLowerCase().includes(keyword)) {\n    should_escalate = true;\n    escalation_reason = 'LLM indica falta de información';\n    break;\n  }\n}\n\n// Regla 3: Respuesta vacía o muy corta\nif (llm_response.length < 10) {\n  should_escalate = true;\n  escalation_reason = 'Respuesta LLM vacía o muy corta';\n}\n\nreturn [{\n  json: {\n    ...($json || {}),\n    should_escalate_info: should_escalate,\n    escalation_reason_info: escalation_reason,\n    validation_passed: !should_escalate\n  }\n}];\n","notice":""},"id":"code-validate-response","name":"Validar Respuesta","type":"n8n-nodes-base.code","typeVersion":2,"position":[3024,356]},{"parameters":{"conditions":{"boolean":[{"value1":"{{ $json.validation_passed }}","value2":true}]},"options":{}},"id":"if-valid-response","name":"¿Respuesta Válida?","type":"n8n-nodes-base.if","typeVersion":2,"position":[3248,356]},{"parameters":{"curlImport":"","method":"POST","url":"https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-send-info-response","name":"Enviar Respuesta INFO","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[3696,404],"credentials":{"httpHeaderAuth":{"id":"WFetbM7hOkXyDliD","name":"Header Auth account"}}},{"parameters":{"curlImport":"","method":"POST","url":"https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-create-note-info","name":"Crear Nota Interna INFO","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[3920,404],"credentials":{"httpHeaderAuth":{"id":"WFetbM7hOkXyDliD","name":"Header Auth account"}}},{"parameters":{"curlImport":"","method":"PATCH","url":"https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","provideSslCertificates":false,"sendQuery":false,"sendHeaders":false,"sendBody":false,"options":{},"infoMessage":""},"id":"http-update-attributes-info","name":"Actualizar Attributes INFO","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[4144,404],"credentials":{"httpHeaderAuth":{"id":"WFetbM7hOkXyDliD","name":"Header Auth account"}}},{"parameters":{"conditions":{"options":{},"combinator":"and","conditions":[{"id":"d37a74ac-c471-4457","leftValue":"={{ $json.intent }}","rightValue":"INFO","operator":{"type":"string","operation":"equals"}}]},"options":{}},"id":"if-check-info-intent","name":"Check INFO Intent","type":"n8n-nodes-base.if","typeVersion":2,"position":[1904,252]},{"parameters":{"conditions":{"options":{},"combinator":"and","conditions":[{"id":"783d23a7-79df-43ce","leftValue":"={{ $json.message_type }}","rightValue":"incoming","operator":{"type":"string","operation":"equals"}}]},"options":{}},"id":"if-is-user-message","name":"IsUserMessage","type":"n8n-nodes-base.if","typeVersion":2,"position":[656,284]}],"connections":{"Chatwoot Webhook":{"main":[[{"node":"Validar Input","type":"main","index":0}]]},"Validar Input":{"main":[[{"node":"IsUserMessage","type":"main","index":0}]]},"WhatsApp Safe Check":{"main":[[{"node":"Clasificador de Intención","type":"main","index":0}]]},"Clasificador de Intención":{"main":[[{"node":"Normalizar Intent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Clasificador de Intención","type":"ai_languageModel","index":0}]]},"Normalizar Intent":{"main":[[{"node":"Check INFO Intent","type":"main","index":0}]]},"Router de Intención":{"main":[[{"node":"Preparar Escalado","type":"main","index":0}],[{"node":"Knowledge Base","type":"main","index":0}],[{"node":"Preparar Escalado","type":"main","index":0}],[{"node":"Preparar Escalado","type":"main","index":0}]]},"Knowledge Base":{"main":[[{"node":"Preparar Prompt INFO","type":"main","index":0}]]},"Preparar Prompt INFO":{"main":[[{"node":"Llamar OpenAI API","type":"main","index":0}]]},"Llamar OpenAI API":{"main":[[{"node":"Extraer Respuesta LLM","type":"main","index":0}]]},"Extraer Respuesta LLM":{"main":[[{"node":"Validar Respuesta","type":"main","index":0}]]},"Validar Respuesta":{"main":[[{"node":"¿Respuesta Válida?","type":"main","index":0}]]},"¿Respuesta Válida?":{"main":[[{"node":"Enviar Respuesta INFO","type":"main","index":0}],[{"node":"Preparar Escalado","type":"main","index":0}]]},"Enviar Respuesta INFO":{"main":[[{"node":"Crear Nota Interna INFO","type":"main","index":0}]]},"Crear Nota Interna INFO":{"main":[[{"node":"Actualizar Attributes INFO","type":"main","index":0}]]},"Actualizar Attributes INFO":{"main":[[{"node":"Responder OK","type":"main","index":0}]]},"Preparar Escalado":{"main":[[{"node":"Enviar Mensaje Escalado","type":"main","index":0}]]},"Enviar Mensaje Escalado":{"main":[[{"node":"Crear Nota Interna","type":"main","index":0}]]},"Crear Nota Interna":{"main":[[{"node":"Actualizar Custom Attributes","type":"main","index":0}]]},"Actualizar Custom Attributes":{"main":[[{"node":"Responder OK","type":"main","index":0}]]},"Check INFO Intent":{"main":[[{"node":"Knowledge Base","type":"main","index":0}],[{"node":"Preparar Escalado","type":"main","index":0}]]},"IsUserMessage":{"main":[[{"node":"WhatsApp Safe Check","type":"main","index":0}],[{"node":"Responder OK","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":{},"pinData":{}},"customData":{}}],"nextCursor":"eyJsYXN0SWQiOiI4ODIiLCJsaW1pdCI6MX0="}