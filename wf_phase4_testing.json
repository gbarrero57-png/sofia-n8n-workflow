{
  "name": "Sofia",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot-sofia",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-chatwoot",
      "name": "Chatwoot Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        208,
        376
      ],
      "webhookId": "chatwoot-sofia"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// VALIDAR INPUT + DETECTAR CONTACTO NUEVO\n// ============================================\nconst payload = $input.item.json.body || $input.item.json;\n\n// Campos del evento\nconst event = payload.event;\nconst content = payload.content || '';\nconst conversation_id = payload.conversation?.id;\nconst inbox_id = payload.conversation?.inbox_id;\nconst clinic_id = payload.conversation?.custom_attributes?.clinic_id;\nconst patient_id = payload.conversation?.custom_attributes?.patient_id;\nconst contact_phone = payload.conversation?.contact_inbox?.source_id;\nconst contact_id = payload.sender?.id;\nconst channel_type = payload.conversation?.contact_inbox?.inbox?.channel_type;\nconst account_id = payload.account?.id || 2;\nconst message_type = payload.message_type;\nconst created_at = payload.created_at;\n\n// Obtener contador de interacciones bot\nconst bot_count = payload.conversation?.custom_attributes?.bot_interaction_count || 0;\nconst last_bot_message = payload.conversation?.custom_attributes?.last_bot_message_at;\nconst contact_inboxes = payload.conversation?.contact_inbox;\nconst has_contact_inbox = !!contact_inboxes;\n\nreturn [{\n  json: {\n    message_text: (content || '').trim(),\n    conversation_id: conversation_id,\n    inbox_id: inbox_id,\n    inbox_id_api: 2,\n    inbox_id_db: 3,\n    clinic_id: clinic_id || 'default',\n    patient_id: patient_id,\n    contact_phone: contact_phone,\n    contact_id: contact_id,\n    account_id: account_id,\n    message_type: message_type,\n    message_timestamp: created_at,\n    bot_interaction_count: bot_count,\n    last_bot_message_at: last_bot_message,\n    sender_name: payload.sender?.name || 'Paciente',\n    sender_email: payload.sender?.email,\n    conversation_status: payload.conversation?.status,\n    has_contact_inbox: has_contact_inbox,\n    channel_type: channel_type || 'Channel::WebWidget',\n    raw_payload: payload\n  }\n}];\n"
      },
      "id": "code-validate",
      "name": "Validar Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        376
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// WHATSAPP SAFE RULES - FASE 1\n// ============================================\nconst bot_count = $json.bot_interaction_count || 0;\nconst message_lower = ($json.message_text || '').toLowerCase();\n\n// Regla 1: M√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬°ximo 1 interacci√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≥n autom√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬°tica en Fase 1\nif (bot_count >= 1) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MAX_INTERACTIONS_PHASE1',\n      debug_rule: 'RULE_1_MAX_INTERACTIONS',\n      debug_bot_count: bot_count,\n      escalation_message: 'Te conecto con un agente de inmediato.'\n    }\n  }];\n}\n\n// Regla 2: Mensaje > 24h\nconst message_age_hours = (Date.now() - ($json.message_timestamp * 1000)) / (1000 * 60 * 60);\nif (message_age_hours > 24) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MESSAGE_TOO_OLD',\n      debug_rule: 'RULE_2_MESSAGE_AGE',\n      debug_age_hours: message_age_hours,\n      escalation_message: 'Te conecto con un agente.'\n    }\n  }];\n}\n\n// Regla 3: Horario comercial (Lima, Peru)\nconst now = new Date();\nconst lima_hour = parseInt(now.toLocaleString('en-US', { \n  timeZone: 'America/Lima', \n  hour: 'numeric', \n  hour12: false \n}));\n\nif (lima_hour < 8 || lima_hour >= 22) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'OUTSIDE_BUSINESS_HOURS',\n      debug_rule: 'RULE_3_HOURS',\n      debug_lima_hour: lima_hour,\n      debug_now: now.toISOString(),\n      escalation_message: 'Gracias por escribirnos. Te responderemos en horario de atenci√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≥n (8am - 10pm).'\n    }\n  }];\n}\n\n// Regla 4: Emergencias\nconst emergency_keywords = [\n  'emergencia', 'urgencia', 'dolor fuerte', 'sangra', 'mucho dolor',\n  'me ca√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≠', 'golpe', 'accidente', 'no puedo', 'ayuda urgente',\n  'hinchaz√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≥n', 'infecci√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≥n', 'fiebre'\n];\nconst is_emergency = emergency_keywords.some(kw => message_lower.includes(kw));\n\nif (is_emergency) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'EMERGENCY_DETECTED',\n      debug_rule: 'RULE_4_EMERGENCY',\n      escalation_message: 'Detecto que podr√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬≠as tener una urgencia. Te conecto de inmediato con nuestro equipo.',\n      priority: 'urgent'\n    }\n  }];\n}\n\n// Regla 5: Opt-out\nconst opt_out_keywords = ['detente', 'ya no', 'basta', 'stop', 'cancelar bot', 'agente', 'humano', 'persona'];\nconst wants_opt_out = opt_out_keywords.some(kw => message_lower.includes(kw));\n\nif (wants_opt_out) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'USER_OPT_OUT',\n      debug_rule: 'RULE_5_OPT_OUT',\n      escalation_message: 'Entendido. Te conecto con un agente humano.'\n    }\n  }];\n}\n\n// Todo OK - continuar al clasificador\nreturn [{\n  json: {\n    ...$json,\n    should_escalate: false,\n    whatsapp_safe: true,\n    debug_rule: 'NO_ESCALATION_ALL_OK',\n    debug_bot_count: bot_count,\n    debug_lima_hour: lima_hour,\n    checked_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-whatsapp-safe",
      "name": "WhatsApp Safe Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        304
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "{{ $json.message_text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are an intent classifier for SofIA dental clinic assistant.\n\nRESPOND ONLY with valid JSON:\n{\n  \"intent\": \"CREATE_EVENT\" | \"INFO\" | \"PAYMENT\" | \"HUMAN\",\n  \"confidence\": \"high\" | \"medium\" | \"low\"\n}\n\nCLASSIFICATION RULES (STRICT PRIORITY ORDER):\n\n1. CREATE_EVENT - HIGHEST PRIORITY\n   **KEYWORDS THAT ALWAYS MEAN CREATE_EVENT:**\n   - agendar, reservar, cita, turno, hora, appointment\n   - \"quiero una cita\", \"necesito cita\", \"agendar\", \"reservar hora\"\n   - \"cuando puedo ir\", \"disponibilidad\", \"horarios disponibles para cita\"\n   **IF MESSAGE CONTAINS THESE = CREATE_EVENT, NOT INFO**\n\n2. PAYMENT - SECOND PRIORITY\n   **KEYWORDS:**\n   - pagÔøΩ, pagar, transferencia, depositÔøΩ, efectivo, tarjeta\n   - \"ya paguÔøΩ\", \"cÔøΩmo pagar\", \"mÔøΩtodos de pago\"\n   **IF MENTIONS PAYMENT ACTION = PAYMENT**\n\n3. HUMAN - THIRD PRIORITY\n   **ONLY FOR:**\n   - emergencia, urgencia, dolor fuerte, sangrado\n   - queja, reclamo, problema grave\n   - factura, seguro, documentos\n   **URGENT/COMPLEX ISSUES ONLY**\n\n4. INFO - LAST RESORT\n   **ONLY IF NONE OF THE ABOVE:**\n   - General questions: precios, servicios, horarios generales, ubicaciÔøΩn\n   - \"cuÔøΩnto cuesta\", \"quÔøΩ servicios\", \"dÔøΩnde estÔøΩn\"\n   **BUT: If asking about appointment availability = CREATE_EVENT!**\n\n**CRITICAL**:\n- \"cita\" or \"agendar\" ALWAYS = CREATE_EVENT\n- \"paguÔøΩ\" or \"pagar\" ALWAYS = PAYMENT\n- When in doubt between CREATE_EVENT and INFO, choose CREATE_EVENT\n"
        }
      },
      "id": "agent-classifier",
      "name": "Clasificador de Intenci√≥n",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        1552,
        180
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "maxTokens": 50,
          "temperature": 0.1
        }
      },
      "id": "openai-model",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1624,
        404
      ],
      "credentials": {
        "openAiApi": {
          "id": "SeCPLJI4mV6p2hJR",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// NORMALIZAR OUTPUT DEL CLASIFICADOR\n// Check if Pre-Clasificador already classified\n// ============================================\n\n// If Pre-Clasificador already classified, use that\nif ($json.skip_ai === true && $json.intent) {\n  return [{\n    json: {\n      ...$json,\n      classified_at: new Date().toISOString(),\n      phase: 'PHASE_1_WITH_PRE_CLASSIFIER'\n    }\n  }];\n}\n\n// Otherwise, parse AI Clasificador output\nlet intent_data = $json.output || $json;\n\nif (typeof intent_data === 'string') {\n  try {\n    intent_data = JSON.parse(intent_data);\n  } catch (e) {\n    const text = intent_data.toLowerCase();\n    if (text.includes('create_event')) {\n      intent_data = { intent: 'CREATE_EVENT', confidence: 'low' };\n    } else if (text.includes('info')) {\n      intent_data = { intent: 'INFO', confidence: 'low' };\n    } else if (text.includes('payment')) {\n      intent_data = { intent: 'PAYMENT', confidence: 'low' };\n    } else {\n      intent_data = { intent: 'HUMAN', confidence: 'low' };\n    }\n  }\n}\n\nlet intent = (intent_data.intent || 'HUMAN').trim().toUpperCase();\nlet confidence = (intent_data.confidence || 'low').toLowerCase();\n\nconst valid_intents = ['CREATE_EVENT', 'INFO', 'PAYMENT', 'HUMAN'];\nif (!valid_intents.includes(intent)) {\n  intent = 'HUMAN';\n  confidence = 'low';\n}\n\nreturn [{\n  json: {\n    ...$json,\n    intent: intent,\n    confidence: confidence,\n    classified_at: new Date().toISOString(),\n    phase: 'PHASE_1_WITH_AI_CLASSIFIER'\n  }\n}];"
      },
      "id": "code-normalize",
      "name": "Normalizar Intent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// Preservar TODOS los datos del input\nreturn [{\n  json: {\n    ...$json,\n    escalation_message_final: $json.escalation_message || 'Te conecto con un agente de nuestro equipo.',\n    escalation_reason_final: $json.escalation_reason || 'PHASE_1_' + $json.intent,\n    internal_note: 'SofIA (Fase 1) - Intent: ' + $json.intent,\n    is_urgent: $json.priority === 'urgent'\n  }\n}];"
      },
      "id": "set-prepare",
      "name": "Preparar Escalado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4144,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $json.escalation_message_final }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}",
        "options": {}
      },
      "id": "http-send-message",
      "name": "Enviar Mensaje Escalado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4368,
        112
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"SofIA Bot - Fase 1\\n\\nIntencion: {{ $json.intent }}\\nConfianza: {{ $json.confidence }}\\nRazon: {{ $json.escalation_reason || \\\"Testing\\\" }}\\nMensaje: {{ $json.message_text }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": true\n}",
        "options": {}
      },
      "id": "http-note",
      "name": "Crear Nota Interna",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4592,
        112
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"custom_attributes\": {\n    \"bot_handled\": true,\n    \"intent_detected\": \"{{ $json.intent }}\",\n    \"confidence\": \"{{ $json.confidence }}\",\n    \"bot_interaction_count\": {{ ($json.bot_interaction_count || 0) + 1 }},\n    \"last_bot_message_at\": \"{{ $now.toISO() }}\",\n    \"escalation_reason\": \"{{ $json.escalation_reason_final }}\",\n    \"sofia_phase\": \"PHASE_1\"\n  }\n}",
        "options": {}
      },
      "id": "http-attributes",
      "name": "Actualizar Custom Attributes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4816,
        112
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ status: 'ok', processed: true, intent: $json.intent, conversation_id: $json.conversation_id }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-webhook",
      "name": "Responder OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        5040,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// KNOWLEDGE BASE - FASE 2\n// Base de conocimiento est√°tica de la cl√≠nica\n// ============================================\n\nconst KNOWLEDGE_BASE = {\n  \"clinic_info\": {\n    \"name\": \"Cl√≠nica Dental SofIA Dent (Test)\",\n    \"address\": \"Av. Principal 123, San Isidro, Lima, Per√∫\",\n    \"phone\": \"+51 905 858 566\",\n    \"email\": \"info@redsolucionesti.com\",\n    \"website\": \"https://sofia-test.redsolucionesti.com\"\n  },\n  \"hours\": {\n    \"weekdays\": \"Lunes a Viernes: 9:00 AM - 7:00 PM\",\n    \"saturday\": \"S√°bados: 9:00 AM - 2:00 PM\",\n    \"sunday\": \"Domingos: Cerrado\"\n  },\n  \"services\": [\n    {\n      \"name\": \"Limpieza dental\",\n      \"price_range\": \"S/ 80 - S/ 150\",\n      \"duration\": \"30-45 minutos\",\n      \"description\": \"Limpieza profesional con ultrasonido\"\n    },\n    {\n      \"name\": \"Blanqueamiento dental\",\n      \"price_range\": \"S/ 300 - S/ 500\",\n      \"duration\": \"60 minutos\",\n      \"description\": \"Blanqueamiento LED profesional\"\n    },\n    {\n      \"name\": \"Consulta general\",\n      \"price_range\": \"S/ 50 - S/ 80\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Evaluaci√≥n completa con radiograf√≠a panor√°mica\"\n    },\n    {\n      \"name\": \"Ortodoncia\",\n      \"price_range\": \"S/ 2,500 - S/ 5,000\",\n      \"duration\": \"12-24 meses\",\n      \"description\": \"Brackets met√°licos o est√©ticos. Incluye controles mensuales.\"\n    },\n    {\n      \"name\": \"Extracci√≥n simple\",\n      \"price_range\": \"S/ 100 - S/ 200\",\n      \"duration\": \"30 minutos\",\n      \"description\": \"Extracci√≥n de piezas dentales no complicadas\"\n    },\n    {\n      \"name\": \"Endodoncia (tratamiento de conducto)\",\n      \"price_range\": \"S/ 300 - S/ 600\",\n      \"duration\": \"60-90 minutos\",\n      \"description\": \"Tratamiento de conducto por pieza dental\"\n    },\n    {\n      \"name\": \"Implante dental\",\n      \"price_range\": \"S/ 2,000 - S/ 3,500\",\n      \"duration\": \"3-6 meses (proceso completo)\",\n      \"description\": \"Implante de titanio + corona. Requiere evaluaci√≥n previa.\"\n    },\n    {\n      \"name\": \"Carillas dentales\",\n      \"price_range\": \"S/ 400 - S/ 800 por pieza\",\n      \"duration\": \"2-3 citas\",\n      \"description\": \"Carillas de resina o porcelana\"\n    }\n  ],\n  \"payment_methods\": [\n    \"Efectivo\",\n    \"Tarjeta de cr√©dito/d√©bito (Visa, Mastercard)\",\n    \"Transferencia bancaria (BCP, Interbank, BBVA)\",\n    \"Yape / Plin\"\n  ],\n  \"faq\": [\n    {\n      \"question\": \"¬øTienen estacionamiento?\",\n      \"answer\": \"S√≠, contamos con estacionamiento gratuito para pacientes.\"\n    },\n    {\n      \"question\": \"¬øAtienden emergencias?\",\n      \"answer\": \"S√≠, atendemos emergencias dentales en horario de atenci√≥n. Fuera de horario, comun√≠cate al +51 905 858 566.\"\n    },\n    {\n      \"question\": \"¬øTrabajan con seguros?\",\n      \"answer\": \"Trabajamos con R√≠mac, Pac√≠fico y Mapfre. Consulta cobertura espec√≠fica con nuestro equipo.\"\n    },\n    {\n      \"question\": \"¬øPrimera cita tiene costo?\",\n      \"answer\": \"La primera consulta de evaluaci√≥n tiene un costo de S/ 50, que se descuenta si inicias tu tratamiento con nosotros.\"\n    }\n  ]\n};\n\n// Pasar datos al siguiente nodo\nreturn [{\n  json: {\n    ...($json || {}),\n    knowledge_base: KNOWLEDGE_BASE,\n    clinic_name: KNOWLEDGE_BASE.clinic_info.name,\n    knowledge_base_json: JSON.stringify(KNOWLEDGE_BASE, null, 2)\n  }\n}];\n"
      },
      "id": "code-knowledge-base",
      "name": "Knowledge Base",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        472
      ]
    },
    {
      "parameters": {
        "jsCode": "// Preparar prompt para LLM\nconst knowledge_base_json = $json.knowledge_base_json;\nconst message_text = $json.message_text;\nconst clinic_name = $json.clinic_name;\n\nconst system_prompt = `Eres SofIA, asistente virtual de la cl√≠nica dental ${clinic_name}.\nTu tarea es responder la pregunta del paciente usando √öNICAMENTE la informaci√≥n proporcionada.\n\nINFORMACI√ìN DE LA CL√çNICA:\n${knowledge_base_json}\n\nREGLAS:\n1. Responde SOLO con informaci√≥n que est√© en la base de conocimiento\n2. Si la informaci√≥n no est√° disponible, di EXACTAMENTE: \"No tengo esa informaci√≥n disponible. Te conecto con un agente para ayudarte mejor.\"\n3. S√© amable, conciso y profesional\n4. No inventes precios, horarios ni servicios\n5. Si el paciente pregunta algo que requiere evaluaci√≥n m√©dica, sugiere agendar una cita\n6. M√°ximo 3 oraciones\n7. Responde en espa√±ol\n8. Al final de tu respuesta, siempre pregunta: \"¬øHay algo m√°s en lo que pueda ayudarte?\"`;\n\nconst user_prompt = `PREGUNTA DEL PACIENTE:\n${message_text}`;\n\nreturn [{\n  json: {\n    ...($json || {}),\n    system_prompt: system_prompt,\n    user_prompt: user_prompt\n  }\n}];\n"
      },
      "id": "code-prepare-prompt",
      "name": "Preparar Prompt INFO",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3024,
        472
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o-mini\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": {{ JSON.stringify($json.system_prompt) }}},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json.user_prompt) }}}\n  ],\n  \"temperature\": 0.3,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "http-call-openai",
      "name": "Llamar OpenAI API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        3248,
        472
      ],
      "credentials": {
        "openAiApi": {
          "id": "SeCPLJI4mV6p2hJR",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extraer respuesta del LLM\nconst response = $json;\n\n// La respuesta de OpenAI viene en response.choices[0].message.content\nconst llm_response = response.choices?.[0]?.message?.content || '';\n\n// Obtener datos originales del nodo \"Preparar Prompt INFO\"\nconst original_data = $node[\"Preparar Prompt INFO\"].json;\n\nreturn [{\n  json: {\n    ...original_data,  // Todos los datos originales (conversation_id, account_id, etc.)\n    llm_response: llm_response.trim()\n  }\n}];"
      },
      "id": "code-extract-response",
      "name": "Extraer Respuesta LLM",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        472
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// VALIDACION ANTI-ALUCINACION\n// ============================================\n\nconst llm_response = $json.llm_response || '';\n\n// Flags de validaci√≥n\nlet should_escalate = false;\nlet escalation_reason = '';\n\n// Regla 1: Respuesta muy larga (>500 chars)\nif (llm_response.length > 500) {\n  should_escalate = true;\n  escalation_reason = 'Respuesta LLM muy larga (>500 chars)';\n}\n\n// Regla 2: LLM dice que no tiene informaci√≥n\nconst no_info_keywords = [\n  'no tengo esa informaci√≥n',\n  'no dispongo',\n  'no cuento con',\n  'no tengo informaci√≥n',\n  'no est√° disponible',\n  'te conecto con un agente'\n];\n\nfor (const keyword of no_info_keywords) {\n  if (llm_response.toLowerCase().includes(keyword)) {\n    should_escalate = true;\n    escalation_reason = 'LLM indica falta de informaci√≥n';\n    break;\n  }\n}\n\n// Regla 3: Respuesta vac√≠a o muy corta\nif (llm_response.length < 10) {\n  should_escalate = true;\n  escalation_reason = 'Respuesta LLM vac√≠a o muy corta';\n}\n\nreturn [{\n  json: {\n    ...($json || {}),\n    should_escalate_info: should_escalate,\n    escalation_reason_info: escalation_reason,\n    validation_passed: !should_escalate\n  }\n}];\n"
      },
      "id": "code-validate-response",
      "name": "Validar Respuesta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3696,
        472
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "{{ $json.validation_passed }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "if-valid-response",
      "name": "¬øRespuesta V√°lida?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3920,
        472
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": {{ JSON.stringify($json.llm_response) }},\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}",
        "options": {}
      },
      "id": "http-send-info-response",
      "name": "Enviar Respuesta INFO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        4368,
        520
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"[Fase 2] Pregunta: {{ $json.user_prompt }}\\nRespuesta enviada OK\",\n  \"message_type\": \"outgoing\",\n  \"private\": true\n}",
        "options": {}
      },
      "id": "http-create-note-info",
      "name": "Crear Nota Interna INFO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        4592,
        520
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"custom_attributes\": {\n    \"sofia_phase\": \"PHASE_2_INFO\",\n    \"bot_interaction_count\": {{ ($json.bot_interaction_count || 0) + 1 }},\n    \"last_bot_message_at\": \"{{ $now.toISO() }}\"\n  }\n}",
        "options": {}
      },
      "id": "http-update-attributes-info",
      "name": "Actualizar Attributes INFO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        4816,
        520
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "combinator": "and",
          "conditions": [
            {
              "id": "783d23a7-79df-43ce",
              "leftValue": "={{ $json.message_type }}",
              "rightValue": "incoming",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "if-is-user-message",
      "name": "IsUserMessage",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        656,
        376
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "info-condition",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "INFO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-info",
      "name": "¬øEs INFO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2576,
        568
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// EXPLAIN APPOINTMENT ESCALATION\n// ============================================\nreturn [{\n  json: {\n    ...$json,\n    escalation_message: 'Entiendo que deseas agendar una cita. Te voy a conectar con un agente que te ayudar√° con la programaci√≥n de tu cita.',\n    escalation_reason: 'APPOINTMENT_REQUEST',\n    escalation_note: `Paciente solicit√≥: ${$json.intent}\\nMensaje original: ${$json.message_text}`,\n    should_escalate: true\n  }\n}];"
      },
      "id": "code-explain-appointment",
      "name": "Explicar Agendamiento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        712
      ]
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "family00280432052323677917@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Familia"
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        3696,
        712
      ],
      "id": "794f6c43-17b3-45f7-946d-6f93f2f568c0",
      "name": "Google Calendar: Leer Eventos",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "Dnin5OfNiPb8Nyl4",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// PRE-CLASIFICADOR BASADO EN KEYWORDS\n// Casos obvios que no necesitan AI\n// ============================================\nconst message = ($json.message_text || '').toLowerCase().trim();\n\n// Definir keywords muy espec√≠ficos\nconst CREATE_EVENT_KEYWORDS = [\n    'agendar', 'reservar', 'cita', 'turno', 'hora disponible',\n    'appointment', 'quiero una cita', 'necesito cita',\n    'cuando puedo ir', 'horarios para cita', 'disponibilidad para cita'\n];\n\nconst PAYMENT_KEYWORDS = [\n    'pagu√©', 'pagar', 'transferencia', 'deposit√©',\n    'ya pague', 'como pagar', 'm√©todos de pago',\n    'efectivo', 'tarjeta'\n];\n\nconst EMERGENCY_KEYWORDS = [\n    'emergencia', 'urgencia', 'dolor fuerte', 'sangra',\n    'mucho dolor', 'hinchaz√≥n', 'infecci√≥n'\n];\n\n// Check for obvious CREATE_EVENT\nfor (const keyword of CREATE_EVENT_KEYWORDS) {\n    if (message.includes(keyword)) {\n        return [{\n            json: {\n                ...$json,\n                intent: 'CREATE_EVENT',\n                confidence: 'high',\n                classified_by: 'PRE_CLASSIFIER',\n                skip_ai: true\n            }\n        }];\n    }\n}\n\n// Check for PAYMENT\nfor (const keyword of PAYMENT_KEYWORDS) {\n    if (message.includes(keyword)) {\n        return [{\n            json: {\n                ...$json,\n                intent: 'PAYMENT',\n                confidence: 'high',\n                classified_by: 'PRE_CLASSIFIER',\n                skip_ai: true\n            }\n        }];\n    }\n}\n\n// Check for EMERGENCY\nfor (const keyword of EMERGENCY_KEYWORDS) {\n    if (message.includes(keyword)) {\n        return [{\n            json: {\n                ...$json,\n                intent: 'HUMAN',\n                confidence: 'high',\n                classified_by: 'PRE_CLASSIFIER',\n                skip_ai: true\n            }\n        }];\n    }\n}\n\n// No match - send to AI Clasificador\nreturn [{\n    json: {\n        ...$json,\n        skip_ai: false\n    }\n}];"
      },
      "id": "code-pre-classifier",
      "name": "Pre-Clasificador Keywords",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "skip-ai-check",
              "leftValue": "={{ $json.skip_ai }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-bypass-ai",
      "name": "¬øYa clasificado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1328,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// CALCULATE AVAILABLE 30-MIN SLOTS\n// ============================================\nconst busy_events = $input.all();\n\n// Business hours\nconst business_hours = {\n  1: { start: 9, end: 19 },  // Monday\n  2: { start: 9, end: 19 },  // Tuesday\n  3: { start: 9, end: 19 },  // Wednesday\n  4: { start: 9, end: 19 },  // Thursday\n  5: { start: 9, end: 19 },  // Friday\n  6: { start: 9, end: 14 },  // Saturday\n  0: null,  // Sunday - closed\n  7: null\n};\n\n// Extract busy times from calendar events\nconst busy_times = [];\nfor (const item of busy_events) {\n  const event = item.json;\n  if (event.start && event.end) {\n    const start_time = event.start.dateTime || event.start.date;\n    const end_time = event.end.dateTime || event.end.date;\n    busy_times.push({\n      start: new Date(start_time),\n      end: new Date(end_time)\n    });\n  }\n}\n\n// Generate all possible slots for next 7 days\nconst slots = [];\nconst now = new Date();\nconst slot_duration = 30; // minutes\n\nfor (let day = 0; day < 7; day++) {\n  const date = new Date(now);\n  date.setDate(date.getDate() + day);\n  date.setHours(0, 0, 0, 0);\n\n  const day_of_week = date.getDay();\n  const hours = business_hours[day_of_week];\n\n  if (!hours) continue; // Closed day\n\n  // Generate slots for this day\n  for (let hour = hours.start; hour < hours.end; hour++) {\n    for (let minute = 0; minute < 60; minute += slot_duration) {\n      const slot_start = new Date(date);\n      slot_start.setHours(hour, minute, 0, 0);\n\n      const slot_end = new Date(slot_start);\n      slot_end.setMinutes(slot_end.getMinutes() + slot_duration);\n\n      // Skip past slots\n      if (slot_start < now) continue;\n\n      // Check if slot conflicts with busy times\n      let is_available = true;\n      for (const busy of busy_times) {\n        if (slot_start < busy.end && slot_end > busy.start) {\n          is_available = false;\n          break;\n        }\n      }\n\n      if (is_available) {\n        slots.push({\n          start: slot_start.toISOString(),\n          end: slot_end.toISOString(),\n          date: slot_start.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),\n          time: slot_start.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' })\n        });\n      }\n    }\n  }\n}\n\n// Limit to first 20 available slots\nconst available_slots = slots.slice(0, 20);\n\nreturn [{\n  json: {\n    ...$json,\n    available_slots: available_slots,\n    total_available: available_slots.length,\n    busy_events_count: busy_times.length,\n    calculated_at: new Date().toISOString()\n  }\n}];"
      },
      "id": "code-calculate-slots",
      "name": "Calcular Slots Disponibles",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        712
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// SELECT 3 BEST SLOTS TO OFFER\n// ============================================\nconst all_slots = $json.available_slots || [];\n\nif (all_slots.length === 0) {\n  return [{\n    json: {\n      ...$json,\n      selected_slots: [],\n      no_slots_available: true,\n      should_escalate: true,\n      escalation_reason: 'NO_SLOTS_AVAILABLE',\n      escalation_message: 'Lo siento, no hay horarios disponibles en los pr√≥ximos 7 d√≠as. Te conecto con un agente.'\n    }\n  }];\n}\n\n// Take first 3 available slots\nconst selected = all_slots.slice(0, 3);\n\n// Format for patient message\nconst slot_options = selected.map((slot, idx) => {\n  return {\n    option_number: idx + 1,\n    date: slot.date,\n    time: slot.time,\n    start_iso: slot.start,\n    end_iso: slot.end\n  };\n});\n\nreturn [{\n  json: {\n    ...$json,\n    selected_slots: slot_options,\n    has_slots: true,\n    total_offered: slot_options.length\n  }\n}];"
      },
      "id": "code-select-slots",
      "name": "Seleccionar 3 Mejores Slots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4144,
        712
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// FORMAT SLOT OFFER MESSAGE\n// ============================================\nconst slots = $json.selected_slots || [];\n\nif (slots.length === 0) {\n  return [{\n    json: {\n      ...$json,\n      offer_message: 'Lo siento, no hay horarios disponibles en los pr√≥ximos 7 d√≠as.',\n      should_escalate: true,\n      escalation_reason: 'NO_SLOTS_AVAILABLE'\n    }\n  }];\n}\n\n// Format message with 3 options\nlet message = '¬°Perfecto! Tengo estos horarios disponibles para tu cita:\\n\\n';\n\nslots.forEach(slot => {\n  message += `${slot.option_number}. ${slot.date} a las ${slot.time}\\n`;\n});\n\nmessage += '\\nPor favor responde con el n√∫mero de la opci√≥n que prefieres (1, 2 o 3).';\n\nreturn [{\n  json: {\n    ...$json,\n    offer_message: message,\n    offered_slots: slots,\n    awaiting_slot_confirmation: true,\n    should_escalate: false\n  }\n}];"
      },
      "id": "code-format-offer",
      "name": "Formatear Oferta de Slots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4368,
        712
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ content: $json.offer_message, message_type: 'outgoing', private: false }) }}",
        "options": {}
      },
      "id": "http-send-offer",
      "name": "Enviar Oferta Chatwoot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4592,
        712
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/custom_attributes",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ custom_attributes: { awaiting_slot_confirmation: 'true', offered_slots: JSON.stringify($json.offered_slots), bot_interaction_count: 1 } }) }}",
        "options": {}
      },
      "id": "http-set-flag",
      "name": "Marcar Esperando Confirmaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4816,
        712
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// PREPARE ESCALATION WITH SLOT CONTEXT\n// ============================================\nconst slots = $json.offered_slots || [];\n\nlet escalation_note = 'Paciente solicit√≥ agendar cita.\\n\\n';\nescalation_note += 'Horarios ofrecidos:\\n';\n\nslots.forEach(slot => {\n  escalation_note += `${slot.option_number}. ${slot.date} a las ${slot.time}\\n`;\n});\n\nescalation_note += '\\nEsperando respuesta del paciente para confirmar el horario.';\n\nreturn [{\n  json: {\n    ...$json,\n    escalation_message: 'Gracias. Un agente se pondr√° en contacto contigo pronto para confirmar tu cita.',\n    escalation_note: escalation_note,\n    escalation_reason: 'PHASE3_SLOTS_OFFERED',\n    should_escalate: true\n  }\n}];"
      },
      "id": "code-prepare-slot-escalation",
      "name": "Preparar Escalado con Slots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        1000
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// CHECK IF AWAITING SLOT CONFIRMATION\n// ============================================\nconst custom_attrs = $json.raw_payload?.conversation?.custom_attributes;\nconst awaiting = custom_attrs?.awaiting_slot_confirmation === 'true';\nconst offered_slots = custom_attrs?.offered_slots;\n\n// Parse offered_slots if string\nlet slots = [];\nif (typeof offered_slots === 'string') {\n    try {\n        slots = JSON.parse(offered_slots);\n    } catch (e) {\n        slots = [];\n    }\n} else if (Array.isArray(offered_slots)) {\n    slots = offered_slots;\n}\n\nreturn [{\n    json: {\n        ...$json,\n        slot_confirmation_pending: awaiting,\n        offered_slots: slots,\n        is_second_interaction: awaiting\n    }\n}];"
      },
      "id": "code-check-slot-state",
      "name": "Check Slot Confirmation State",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "awaiting-slot-check",
              "leftValue": "={{ $json.slot_confirmation_pending }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-awaiting-confirmation",
      "name": "¬øEsperando Confirmaci√≥n Slot?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2352,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// PROCESS USER'S SLOT SELECTION\n// ============================================\nconst message = ($json.message_text || '').toLowerCase();\nconst slots = $json.offered_slots || [];\n\nif (slots.length === 0) {\n    return [{\n        json: {\n            ...$json,\n            slot_chosen: false,\n            needs_clarification: true,\n            error_reason: 'NO_SLOTS_IN_CONTEXT'\n        }\n    }];\n}\n\n// Try to match by number (1, 2, 3)\nlet chosen_slot = null;\nlet chosen_index = -1;\n\nif (message.match(/\\b1\\b/) || message.includes('primer') || message.includes('primera')) {\n    chosen_slot = slots[0];\n    chosen_index = 0;\n} else if (message.match(/\\b2\\b/) || message.includes('segund')) {\n    chosen_slot = slots[1];\n    chosen_index = 1;\n} else if (message.match(/\\b3\\b/) || message.includes('tercer')) {\n    chosen_slot = slots[2];\n    chosen_index = 2;\n}\n\n// Try to match by day name\nif (!chosen_slot) {\n    const days = ['lunes', 'martes', 'mi√©rcoles', 'miercoles', 'jueves', 'viernes', 's√°bado', 'sabado'];\n    for (let i = 0; i < slots.length; i++) {\n        const slot = slots[i];\n        const slot_text = (slot.date || '').toLowerCase();\n        for (const day of days) {\n            if (message.includes(day) && slot_text.includes(day)) {\n                chosen_slot = slot;\n                chosen_index = i;\n                break;\n            }\n        }\n        if (chosen_slot) break;\n    }\n}\n\nif (!chosen_slot) {\n    return [{\n        json: {\n            ...$json,\n            slot_chosen: false,\n            needs_clarification: true,\n            error_reason: 'SLOT_NOT_IDENTIFIED'\n        }\n    }];\n}\n\nreturn [{\n    json: {\n        ...$json,\n        slot_chosen: true,\n        chosen_slot: chosen_slot,\n        chosen_slot_index: chosen_index + 1,\n        needs_clarification: false\n    }\n}];"
      },
      "id": "code-process-slot-choice",
      "name": "Procesar Elecci√≥n Slot",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.slot_chosen }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "if-slot-chosen-valid",
      "name": "¬øSlot V√°lido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3024,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ content: 'No logr√© identificar qu√© horario prefieres. ¬øPodr√≠as decirme el n√∫mero de la opci√≥n (1, 2 o 3)?', message_type: 'outgoing', private: false }) }}",
        "options": {}
      },
      "id": "http-ask-clarification",
      "name": "Pedir Aclaraci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4816,
        304
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// LOCK SLOT - Prepare event data\n// ============================================\nconst slot = $json.chosen_slot;\nconst patient = $json.sender_name || 'Paciente';\nconst phone = $json.contact_phone || 'No disponible';\n\n// Extract service type from original message (basic extraction)\nconst original_msg = ($json.message_text || '').toLowerCase();\nlet service = 'Consulta general';\n\nif (original_msg.includes('limpieza')) {\n    service = 'Limpieza dental';\n} else if (original_msg.includes('blanqueamiento')) {\n    service = 'Blanqueamiento dental';\n} else if (original_msg.includes('ortodoncia')) {\n    service = 'Ortodoncia';\n} else if (original_msg.includes('extracci√≥n') || original_msg.includes('extraccion')) {\n    service = 'Extracci√≥n';\n} else if (original_msg.includes('endodoncia') || original_msg.includes('conducto')) {\n    service = 'Endodoncia';\n} else if (original_msg.includes('implante')) {\n    service = 'Implante dental';\n}\n\nreturn [{\n    json: {\n        ...$json,\n        event_summary: `${service} - ${patient}`,\n        event_description: `Paciente: ${patient}\\nTel√©fono: ${phone}\\nServicio: ${service}\\n\\nAgendado autom√°ticamente por SofIA Bot`,\n        event_start: slot.start_iso,\n        event_end: slot.end_iso,\n        event_location: 'Cl√≠nica Dental SofIA Dent',\n        service_type: service\n    }\n}];"
      },
      "id": "code-lock-slot",
      "name": "Lock de Slot",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3248,
        -8
      ]
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "family00280432052323677917@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Familia"
        },
        "start": "={{ $json.event_start }}",
        "end": "={{ $json.event_end }}",
        "additionalFields": {
          "description": "={{ $json.event_description }}",
          "location": "={{ $json.event_location }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        3472,
        -8
      ],
      "id": "google-calendar-create-event",
      "name": "Crear Evento Google Calendar",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "Dnin5OfNiPb8Nyl4",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ !!$json.id }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "if-event-created-ok",
      "name": "¬øEvento Creado OK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3696,
        -8
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// CONFIRM APPOINTMENT TO PATIENT\n// ============================================\n// Get original data from Lock de Slot\nconst original_data = $node[\"Lock de Slot\"].json;\nconst slot = original_data.chosen_slot;\nconst service = original_data.service_type;\n\nconst confirmation_message = `¬°Listo! üéâ Tu cita de ${service} ha sido agendada para el ${slot.date} a las ${slot.time}.\n\nüìç Ubicaci√≥n: Cl√≠nica Dental SofIA Dent\nüìû Si necesitas cambios, ll√°manos al +51 905 858 566\n\n¬°Te esperamos! üòä`;\n\nconst internal_note = `‚úÖ CITA AGENDADA AUTOM√ÅTICAMENTE\n\nüìÖ Fecha/Hora: ${slot.date} a las ${slot.time}\nüìã Servicio: ${service}\nüë§ Paciente: ${original_data.sender_name}\nüì± Tel√©fono: ${original_data.contact_phone}\nüÜî Event ID: ${$json.id}\n\nü§ñ SofIA Fase 4 - Confirmaci√≥n autom√°tica`;\n\nreturn [{\n    json: {\n        ...original_data,\n        confirmation_message: confirmation_message,\n        internal_note: internal_note,\n        event_id: $json.id,\n        event_created: true\n    }\n}];"
      },
      "id": "code-confirm-to-patient",
      "name": "Confirmar al Paciente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4144,
        -80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ content: $json.confirmation_message, message_type: 'outgoing', private: false }) }}",
        "options": {}
      },
      "id": "http-send-confirmation",
      "name": "Enviar Confirmaci√≥n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4368,
        -80
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ content: $json.internal_note, message_type: 'outgoing', private: true }) }}",
        "options": {}
      },
      "id": "http-success-note",
      "name": "Crear Nota √âxito",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4592,
        -80
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "yypAwZDH2dV3crfbqJqWCgj1"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ custom_attributes: { sofia_phase: 'PHASE_4_COMPLETE', awaiting_slot_confirmation: 'false', event_id: $json.event_id, appointment_confirmed: 'true', bot_interaction_count: ($json.bot_interaction_count || 0) + 1 } }) }}",
        "options": {}
      },
      "id": "http-update-success-attrs",
      "name": "Actualizar Attributes √âxito",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4816,
        -80
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// HANDLE CALENDAR CREATION ERROR\n// ============================================\nconst original_data = $node[\"Lock de Slot\"].json;\nconst slot = original_data.chosen_slot;\n\nconst error_message = 'Lo siento, hubo un problema al agendar tu cita. Te conecto con un agente que te ayudar√° de inmediato.';\n\nconst internal_note = `‚ö†Ô∏è ERROR AL CREAR EVENTO EN CALENDAR\n\nüìÖ Slot elegido: ${slot.date} a las ${slot.time}\nüë§ Paciente: ${original_data.sender_name}\nüìã Servicio: ${original_data.service_type}\n\n‚ùå Error: No se pudo crear el evento en Google Calendar\n‚û°Ô∏è Acci√≥n: Crear manualmente y confirmar al paciente\n\nü§ñ SofIA Fase 4 - Error de creaci√≥n`;\n\nreturn [{\n    json: {\n        ...original_data,\n        escalation_message: error_message,\n        escalation_note: internal_note,\n        escalation_reason: 'PHASE4_CALENDAR_ERROR',\n        should_escalate: true,\n        event_created: false\n    }\n}];"
      },
      "id": "code-handle-error",
      "name": "Manejar Error Calendar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        112
      ]
    }
  ],
  "connections": {
    "Chatwoot Webhook": {
      "main": [
        [
          {
            "node": "Validar Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Input": {
      "main": [
        [
          {
            "node": "IsUserMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Safe Check": {
      "main": [
        [
          {
            "node": "Pre-Clasificador Keywords",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clasificador de Intenci√≥n": {
      "main": [
        [
          {
            "node": "Normalizar Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Clasificador de Intenci√≥n",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Intent": {
      "main": [
        [
          {
            "node": "Check Slot Confirmation State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Knowledge Base": {
      "main": [
        [
          {
            "node": "Preparar Prompt INFO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Prompt INFO": {
      "main": [
        [
          {
            "node": "Llamar OpenAI API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Llamar OpenAI API": {
      "main": [
        [
          {
            "node": "Extraer Respuesta LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Respuesta LLM": {
      "main": [
        [
          {
            "node": "Validar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Respuesta": {
      "main": [
        [
          {
            "node": "¬øRespuesta V√°lida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øRespuesta V√°lida?": {
      "main": [
        [
          {
            "node": "Enviar Respuesta INFO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Escalado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta INFO": {
      "main": [
        [
          {
            "node": "Crear Nota Interna INFO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Nota Interna INFO": {
      "main": [
        [
          {
            "node": "Actualizar Attributes INFO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Attributes INFO": {
      "main": [
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Escalado": {
      "main": [
        [
          {
            "node": "Enviar Mensaje Escalado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Mensaje Escalado": {
      "main": [
        [
          {
            "node": "Crear Nota Interna",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Nota Interna": {
      "main": [
        [
          {
            "node": "Actualizar Custom Attributes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Custom Attributes": {
      "main": [
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IsUserMessage": {
      "main": [
        [
          {
            "node": "WhatsApp Safe Check",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs INFO?": {
      "main": [
        [
          {
            "node": "Knowledge Base",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Explicar Agendamiento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Explicar Agendamiento": {
      "main": [
        [
          {
            "node": "Google Calendar: Leer Eventos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Calendar: Leer Eventos": {
      "main": [
        [
          {
            "node": "Calcular Slots Disponibles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pre-Clasificador Keywords": {
      "main": [
        [
          {
            "node": "¬øYa clasificado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øYa clasificado?": {
      "main": [
        [
          {
            "node": "Normalizar Intent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Clasificador de Intenci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Slots Disponibles": {
      "main": [
        [
          {
            "node": "Seleccionar 3 Mejores Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Seleccionar 3 Mejores Slots": {
      "main": [
        [
          {
            "node": "Formatear Oferta de Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Oferta de Slots": {
      "main": [
        [
          {
            "node": "Enviar Oferta Chatwoot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Oferta Chatwoot": {
      "main": [
        [
          {
            "node": "Marcar Esperando Confirmaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar Esperando Confirmaci√≥n": {
      "main": [
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Escalado con Slots": {
      "main": [
        [
          {
            "node": "Preparar Escalado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Slot Confirmation State": {
      "main": [
        [
          {
            "node": "¬øEsperando Confirmaci√≥n Slot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEsperando Confirmaci√≥n Slot?": {
      "main": [
        [
          {
            "node": "Procesar Elecci√≥n Slot",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øEs INFO?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Elecci√≥n Slot": {
      "main": [
        [
          {
            "node": "¬øSlot V√°lido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øSlot V√°lido?": {
      "main": [
        [
          {
            "node": "Lock de Slot",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pedir Aclaraci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pedir Aclaraci√≥n": {
      "main": [
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lock de Slot": {
      "main": [
        [
          {
            "node": "Crear Evento Google Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Evento Google Calendar": {
      "main": [
        [
          {
            "node": "¬øEvento Creado OK?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEvento Creado OK?": {
      "main": [
        [
          {
            "node": "Confirmar al Paciente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Manejar Error Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar al Paciente": {
      "main": [
        [
          {
            "node": "Enviar Confirmaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Confirmaci√≥n": {
      "main": [
        [
          {
            "node": "Crear Nota √âxito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Nota √âxito": {
      "main": [
        [
          {
            "node": "Actualizar Attributes √âxito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Attributes √âxito": {
      "main": [
        [
          {
            "node": "Responder OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manejar Error Calendar": {
      "main": [
        [
          {
            "node": "Preparar Escalado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null
}