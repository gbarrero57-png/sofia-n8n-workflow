{"updatedAt":"2026-02-09T05:14:55.708Z","createdAt":"2026-01-21T18:48:10.157Z","id":"37SLdWISQLgkHeXk","name":"Sofia","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{"method":"POST","url":"=https://chat.redsolucionesti.com/api/v1/accounts/{{ \\.account_id }}/conversations/{{ \\.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"content\": \"SofIA Bot - Fase 1\n\nIntencion: {{ \\.intent }}\nConfianza: {{ \\.confidence }}\nRazon: {{ \\.escalation_reason || \"Testing\" }}\nMensaje: {{ \\.message_text }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": true\n}","options":{}},"id":"1b02b82d-d48a-4439-8df2-33c190ccf374","name":"Crear Nota Interna","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-512,3056]},{"parameters":{"httpMethod":"POST","path":"chatwoot-sofia","responseMode":"responseNode","options":{}},"id":"8b056722-367d-42ef-aeec-0ec7f2bf6115","name":"Chatwoot Webhook1","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2512,3248],"webhookId":"chatwoot-sofia"},{"parameters":{"jsCode":"// ============================================\n// VALIDAR INPUT + DETECTAR CONTACTO NUEVO\n// ============================================\nconst payload = $input.item.json.body || $input.item.json;\n\n// Campos del evento\nconst event = payload.event;\nconst content = payload.content;\nconst conversation_id = payload.conversation?.id;\nconst inbox_id = payload.conversation?.inbox_id;\nconst clinic_id = payload.conversation?.custom_attributes?.clinic_id;\nconst patient_id = payload.conversation?.custom_attributes?.patient_id;\nconst contact_phone = payload.conversation?.contact_inbox?.source_id;\nconst contact_id = payload.sender?.id;\nconst channel_type = payload.conversation?.contact_inbox?.inbox?.channel_type;\nconst account_id = payload.account?.id || 2;\nconst message_type = payload.message_type;\nconst created_at = payload.created_at;\n\n// ---- Validar evento ----\nif (!event || !content) {\n  throw new Error(`Missing event or content`);\n}\n\n// ---- Ignorar eventos que no son mensajes ----\nif (event !== 'message_created') {\n  throw new Error(`Ignored event: ${event}`);\n}\n\n// ---- Ignorar mensajes de tipo outgoing (evitar loops) ----\nif (message_type !== 'incoming') {\n  throw new Error(`Ignored: not incoming message (type: ${message_type})`);\n}\n\n// ---- Detectar si es contacto nuevo sin contact_inbox ----\nconst contact_inboxes = payload.conversation?.contact_inbox;\nconst has_contact_inbox = !!contact_inboxes;\n\n// Obtener contador de interacciones bot\nconst bot_count = payload.conversation?.custom_attributes?.bot_interaction_count || 0;\nconst last_bot_message = payload.conversation?.custom_attributes?.last_bot_message_at;\n\nreturn [{\n  json: {\n    message_text: (content || '').trim(),\n    conversation_id: conversation_id,\n    inbox_id: inbox_id,\n    inbox_id_api: 2,\n    inbox_id_db: 3,\n    clinic_id: clinic_id || 'default',\n    patient_id: patient_id,\n    contact_phone: contact_phone,\n    contact_id: contact_id,\n    account_id: account_id,\n    message_type: message_type,\n    message_timestamp: created_at,\n    bot_interaction_count: bot_count,\n    last_bot_message_at: last_bot_message,\n    sender_name: payload.sender?.name || 'Paciente',\n    sender_email: payload.sender?.email,\n    conversation_status: payload.conversation?.status,\n    has_contact_inbox: has_contact_inbox,\n    channel_type: channel_type || 'Channel::WebWidget',\n    raw_payload: payload\n  }\n}];"},"id":"3899221f-944b-4735-97a1-ef08f6b03c9b","name":"Validar Input1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2320,3248]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.message_type }}","value2":"incoming"}]}},"id":"f23e6dbc-cf3b-4c43-b018-a5331c0b4cc5","name":"Ã‚Â¿Es del Usuario?1","type":"n8n-nodes-base.if","typeVersion":1,"position":[-2112,3248]},{"parameters":{"jsCode":"// ============================================\n// WHATSAPP SAFE RULES - FASE 1\n// ============================================\nconst bot_count = $json.bot_interaction_count || 0;\nconst message_lower = ($json.message_text || '').toLowerCase();\n\n// Regla 1: MÃƒÂ¡ximo 1 interacciÃƒÂ³n automÃƒÂ¡tica en Fase 1\nif (bot_count >= 1) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MAX_INTERACTIONS_PHASE1',\n      escalation_message: 'Te conecto con un agente de inmediato.'\n    }\n  }];\n}\n\n// Regla 2: Mensaje > 24h\nconst message_age_hours = (Date.now() - ($json.message_timestamp * 1000)) / (1000 * 60 * 60);\nif (message_age_hours > 24) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MESSAGE_TOO_OLD',\n      escalation_message: 'Te conecto con un agente.'\n    }\n  }];\n}\n\n// Regla 3: Horario comercial (Lima, Peru)\nconst now = new Date();\nconst lima_hour = parseInt(now.toLocaleString('en-US', { \n  timeZone: 'America/Lima', \n  hour: 'numeric', \n  hour12: false \n}));\n\nif (lima_hour < 8 || lima_hour >= 22) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'OUTSIDE_BUSINESS_HOURS',\n      escalation_message: 'Gracias por escribirnos. Te responderemos en horario de atenciÃƒÂ³n (8am - 10pm).'\n    }\n  }];\n}\n\n// Regla 4: Emergencias\nconst emergency_keywords = [\n  'emergencia', 'urgencia', 'dolor fuerte', 'sangra', 'mucho dolor',\n  'me caÃƒÂ­', 'golpe', 'accidente', 'no puedo', 'ayuda urgente',\n  'hinchazÃƒÂ³n', 'infecciÃƒÂ³n', 'fiebre'\n];\nconst is_emergency = emergency_keywords.some(kw => message_lower.includes(kw));\n\nif (is_emergency) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'EMERGENCY_DETECTED',\n      escalation_message: 'Detecto que podrÃƒÂ­as tener una urgencia. Te conecto de inmediato con nuestro equipo.',\n      priority: 'urgent'\n    }\n  }];\n}\n\n// Regla 5: Opt-out\nconst opt_out_keywords = ['detente', 'ya no', 'basta', 'stop', 'cancelar bot', 'agente', 'humano', 'persona'];\nconst wants_opt_out = opt_out_keywords.some(kw => message_lower.includes(kw));\n\nif (wants_opt_out) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'USER_OPT_OUT',\n      escalation_message: 'Entendido. Te conecto con un agente humano.'\n    }\n  }];\n}\n\n// Todo OK - continuar al clasificador\nreturn [{\n  json: {\n    ...$json,\n    should_escalate: false,\n    whatsapp_safe: true,\n    checked_at: new Date().toISOString()\n  }\n}];"},"id":"59b1e73e-e759-44a0-8980-e96864b766c0","name":"WhatsApp Safe Check1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1920,3152]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.should_escalate }}","value2":true}]}},"id":"95adb79e-2959-415a-a6cd-fd744c35942d","name":"Ã‚Â¿Escalar Ahora?1","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1712,3152]},{"parameters":{"promptType":"define","text":"={{ $json.message_text }}","hasOutputParser":true,"options":{"systemMessage":"You are an intent classifier for a dental clinic virtual assistant named SofIA.\nYour ONLY job is to analyze the patient's message and classify it into ONE category.\n\nYou MUST respond with valid JSON in this exact format:\n{\n  \"intent\": \"CREATE_EVENT\" | \"INFO\" | \"PAYMENT\" | \"HUMAN\",\n  \"confidence\": \"high\" | \"medium\" | \"low\"\n}\n\nCLASSIFICATION RULES:\n\n1. CREATE_EVENT\n   Use when: Patient wants to schedule, reschedule, cancel, or ask about appointment availability\n   Keywords: \"cita\", \"agendar\", \"reservar\", \"cambiar\", \"cancelar\", \"disponibilidad\", \"horario\"\n   Examples: \"Quiero una cita\", \"Tienen disponibilidad maÃƒÂ±ana?\"\n   \n2. INFO\n   Use when: Patient asks about services, prices, location, general information\n   Keywords: \"cuanto cuesta\", \"donde estÃƒÂ¡n\", \"direcciÃƒÂ³n\", \"servicios\"\n   Examples: \"CuÃƒÂ¡nto cuesta una limpieza?\", \"DÃƒÂ³nde estÃƒÂ¡n ubicados?\"\n   \n3. PAYMENT\n   Use when: Patient mentions pending payments or asks how to pay\n   Keywords: \"paguÃƒÂ©\", \"pago\", \"transferencia\", \"saldo\", \"debo\"\n   Examples: \"Ya paguÃƒÂ© mi consulta\", \"CÃƒÂ³mo puedo pagar?\"\n   \n4. HUMAN\n   Use when: Medical emergencies, complaints, complex requests\n   Keywords: \"emergencia\", \"urgencia\", \"dolor fuerte\", \"queja\", \"seguro mÃƒÂ©dico\"\n   Examples: \"Tengo un dolor terrible\", \"Necesito factura\"\n\nCRITICAL RULES:\n- If message mentions \"emergencia\", \"urgencia\", or \"dolor fuerte\" Ã¢â€ â€™ ALWAYS return HUMAN with high confidence\n- If ambiguous between CREATE_EVENT and another Ã¢â€ â€™ choose CREATE_EVENT\n- If greeting without clear intent Ã¢â€ â€™ return INFO with low confidence\n- If you cannot understand Ã¢â€ â€™ return HUMAN with low confidence\n- ALWAYS respond with valid JSON, nothing else"}},"id":"d0fa38a6-62bc-4f73-8f95-7458dd78d276","name":"Clasificador de IntenciÃƒÂ³n1","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[-1520,3056]},{"parameters":{"model":"gpt-4-turbo-preview","options":{"maxTokens":50,"temperature":0.1}},"id":"3750f1ca-21f0-4c1e-9247-f83baa006e9a","name":"OpenAI Chat Model1","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[-1520,3248],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},{"parameters":{"jsCode":"// ============================================\n// NORMALIZAR OUTPUT DEL CLASIFICADOR\n// ============================================\nlet intent_data = $json.output || $json;\n\nif (typeof intent_data === 'string') {\n  try {\n    intent_data = JSON.parse(intent_data);\n  } catch (e) {\n    const text = intent_data.toLowerCase();\n    if (text.includes('create_event')) {\n      intent_data = { intent: 'CREATE_EVENT', confidence: 'low' };\n    } else if (text.includes('info')) {\n      intent_data = { intent: 'INFO', confidence: 'low' };\n    } else if (text.includes('payment')) {\n      intent_data = { intent: 'PAYMENT', confidence: 'low' };\n    } else {\n      intent_data = { intent: 'HUMAN', confidence: 'low' };\n    }\n  }\n}\n\nlet intent = (intent_data.intent || 'HUMAN').trim().toUpperCase();\nlet confidence = (intent_data.confidence || 'low').toLowerCase();\n\nconst valid_intents = ['CREATE_EVENT', 'INFO', 'PAYMENT', 'HUMAN'];\nif (!valid_intents.includes(intent)) {\n  intent = 'HUMAN';\n  confidence = 'low';\n}\n\nreturn [{\n  json: {\n    ...$json,\n    intent: intent,\n    confidence: confidence,\n    classified_at: new Date().toISOString(),\n    phase: 'PHASE_1_TESTING',\n    action: 'ESCALATE_TO_HUMAN'\n  }\n}];"},"id":"27b1bc4a-7610-42b5-81a0-c84baf8bad09","name":"Normalizar Intent1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1312,3056]},{"parameters":{"rules":{"rules":[{},{"output":1},{"output":2},{"output":3}]},"fallbackOutput":3},"id":"f72d9f5b-087c-4577-b929-d7d4a82f6d55","name":"Router de IntenciÃƒÂ³n1","type":"n8n-nodes-base.switch","typeVersion":1,"position":[-1120,3056]},{"parameters":{"values":{"string":[{"name":"escalation_message_final","value":"={{ $json.escalation_message || 'Te conecto con un agente de nuestro equipo.' }}"},{"name":"escalation_reason_final","value":"={{ $json.escalation_reason || 'PHASE_1_' + $json.intent }}"},{"name":"internal_note","value":"=Ã°Å¸Â¤â€“ SofIA (Fase 1)\\n\\nIntenciÃƒÂ³n detectada: {{ $json.intent }} ({{ $json.confidence }})\\nRazÃƒÂ³n: {{ $json.escalation_reason || 'Testing Fase 1' }}\\nMensaje original: \\\"{{ $json.message_text }}\\\"\\nClÃƒÂ­nica: {{ $json.clinic_id }}\\nPaciente: {{ $json.patient_id }}"}],"boolean":[{"name":"is_urgent","value":"={{ $json.priority === 'urgent' ? true : false }}"}]},"options":{}},"id":"941953f3-c679-4e7b-b964-af64b44ecacd","name":"Preparar Escalado1","type":"n8n-nodes-base.set","typeVersion":1,"position":[-912,3056]},{"parameters":{"method":"POST","url":"=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"content\": \"{{ $json.escalation_message_final }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}","options":{}},"id":"d5c4e29a-fcd9-4810-a782-06ea08e4fb63","name":"Enviar Mensaje Escalado1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-720,3056]},{"parameters":{"method":"POST","url":"=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/custom_attributes","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"custom_attributes\": {\n    \"bot_handled\": true,\n    \"intent_detected\": \"{{ $json.intent }}\",\n    \"confidence\": \"{{ $json.confidence }}\",\n    \"bot_interaction_count\": {{ ($json.bot_interaction_count || 0) + 1 }},\n    \"last_bot_message_at\": \"{{ $now.toISO() }}\",\n    \"escalation_reason\": \"{{ $json.escalation_reason_final }}\",\n    \"sofia_phase\": \"PHASE_1\"\n  }\n}","options":{}},"id":"84acb629-c432-4ba4-a09e-d1882ed22133","name":"Actualizar Custom Attributes1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-320,3056]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ status: 'ok', processed: true, intent: $json.intent, conversation_id: $json.conversation_id }) }}","options":{"responseCode":200}},"id":"745d19d1-8f3d-442e-98d7-c145211e3585","name":"Responder OK1","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-112,3248]}],"connections":{"Crear Nota Interna":{"main":[[{"node":"Actualizar Custom Attributes1","type":"main","index":0}]]},"Chatwoot Webhook1":{"main":[[{"node":"Validar Input1","type":"main","index":0}]]},"Validar Input1":{"main":[[{"node":"Ã‚Â¿Es del Usuario?1","type":"main","index":0}]]},"Ã‚Â¿Es del Usuario?1":{"main":[[{"node":"WhatsApp Safe Check1","type":"main","index":0}],[{"node":"Responder OK1","type":"main","index":0}]]},"WhatsApp Safe Check1":{"main":[[{"node":"Ã‚Â¿Escalar Ahora?1","type":"main","index":0}]]},"Ã‚Â¿Escalar Ahora?1":{"main":[[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Clasificador de IntenciÃƒÂ³n1","type":"main","index":0}]]},"Clasificador de IntenciÃƒÂ³n1":{"main":[[{"node":"Normalizar Intent1","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Clasificador de IntenciÃƒÂ³n1","type":"ai_languageModel","index":0}]]},"Normalizar Intent1":{"main":[[{"node":"Router de IntenciÃƒÂ³n1","type":"main","index":0}]]},"Router de IntenciÃƒÂ³n1":{"main":[[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Preparar Escalado1","type":"main","index":0}]]},"Preparar Escalado1":{"main":[[{"node":"Enviar Mensaje Escalado1","type":"main","index":0}]]},"Enviar Mensaje Escalado1":{"main":[[{"node":"Crear Nota Interna","type":"main","index":0}]]},"Actualizar Custom Attributes1":{"main":[[{"node":"Responder OK1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":{"templateId":"3859","templateCredsSetupCompleted":true},"pinData":{},"versionId":"707d56f2-f2e9-4c57-8fd3-6013525276b2","activeVersionId":"65a4b411-4d31-4a83-8dc5-93681c952193","versionCounter":85,"triggerCount":1,"shared":[{"updatedAt":"2026-01-21T18:48:10.172Z","createdAt":"2026-01-21T18:48:10.172Z","role":"workflow:owner","workflowId":"37SLdWISQLgkHeXk","projectId":"rHohNmSvOVaasBRv","project":{"updatedAt":"2025-12-15T18:03:51.136Z","createdAt":"2025-12-15T17:36:08.325Z","id":"rHohNmSvOVaasBRv","name":"Gabriel Barrero <gbarrero57@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"d0578bf7-eabc-4d42-8b83-067e0b33b70c","projectRelations":[{"updatedAt":"2025-12-15T17:36:08.326Z","createdAt":"2025-12-15T17:36:08.326Z","userId":"d0578bf7-eabc-4d42-8b83-067e0b33b70c","projectId":"rHohNmSvOVaasBRv","user":{"updatedAt":"2026-02-09T05:01:47.000Z","createdAt":"2025-12-15T17:36:07.652Z","id":"d0578bf7-eabc-4d42-8b83-067e0b33b70c","email":"gbarrero57@gmail.com","firstName":"Gabriel","lastName":"Barrero","personalizationAnswers":{"version":"v4","personalization_survey_submitted_at":"2025-12-15T18:04:04.664Z","personalization_survey_n8n_version":"2.0.2","companySize":"<20","companyType":"saas","role":"business-owner","reportedSource":"google"},"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"pcjSqYlnURtWWAMc","userActivatedAt":1769234242953,"npsSurvey":{"waitingForResponse":true,"ignoredCount":2,"lastShownAt":1770402015472}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-02-09","isPending":false}}]}}],"tags":[],"activeVersion":{"updatedAt":"2026-02-09T05:01:47.000Z","createdAt":"2026-02-09T04:58:13.629Z","versionId":"65a4b411-4d31-4a83-8dc5-93681c952193","workflowId":"37SLdWISQLgkHeXk","nodes":[{"parameters":{"httpMethod":"POST","path":"chatwoot-sofia","responseMode":"responseNode","options":{}},"id":"8b7cd1f0-e2ee-42cc-83ff-4b6f45437707","name":"Chatwoot Webhook1","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-736,1264],"webhookId":"chatwoot-sofia"},{"parameters":{"jsCode":"// ============================================\n// VALIDAR INPUT + DETECTAR CONTACTO NUEVO\n// ============================================\nconst payload = $input.item.json.body || $input.item.json;\n\n// Campos del evento\nconst event = payload.event;\nconst content = payload.content;\nconst conversation_id = payload.conversation?.id;\nconst inbox_id = payload.conversation?.inbox_id;\nconst clinic_id = payload.conversation?.custom_attributes?.clinic_id;\nconst patient_id = payload.conversation?.custom_attributes?.patient_id;\nconst contact_phone = payload.conversation?.contact_inbox?.source_id;\nconst contact_id = payload.sender?.id;\nconst channel_type = payload.conversation?.contact_inbox?.inbox?.channel_type;\nconst account_id = payload.account?.id || 2;\nconst message_type = payload.message_type;\nconst created_at = payload.created_at;\n\n// ---- Validar evento ----\nif (!event || !content) {\n  throw new Error(`Missing event or content`);\n}\n\n// ---- Ignorar eventos que no son mensajes ----\nif (event !== 'message_created') {\n  throw new Error(`Ignored event: ${event}`);\n}\n\n// ---- Ignorar mensajes de tipo outgoing (evitar loops) ----\nif (message_type !== 'incoming') {\n  throw new Error(`Ignored: not incoming message (type: ${message_type})`);\n}\n\n// ---- Detectar si es contacto nuevo sin contact_inbox ----\nconst contact_inboxes = payload.conversation?.contact_inbox;\nconst has_contact_inbox = !!contact_inboxes;\n\n// Obtener contador de interacciones bot\nconst bot_count = payload.conversation?.custom_attributes?.bot_interaction_count || 0;\nconst last_bot_message = payload.conversation?.custom_attributes?.last_bot_message_at;\n\nreturn [{\n  json: {\n    message_text: (content || '').trim(),\n    conversation_id: conversation_id,\n    inbox_id: inbox_id,\n    inbox_id_api: 2,\n    inbox_id_db: 3,\n    clinic_id: clinic_id || 'default',\n    patient_id: patient_id,\n    contact_phone: contact_phone,\n    contact_id: contact_id,\n    account_id: account_id,\n    message_type: message_type,\n    message_timestamp: created_at,\n    bot_interaction_count: bot_count,\n    last_bot_message_at: last_bot_message,\n    sender_name: payload.sender?.name || 'Paciente',\n    sender_email: payload.sender?.email,\n    conversation_status: payload.conversation?.status,\n    has_contact_inbox: has_contact_inbox,\n    channel_type: channel_type || 'Channel::WebWidget',\n    raw_payload: payload\n  }\n}];"},"id":"df9e3ffb-6f30-4bc7-8aeb-b49c36a2c391","name":"Validar Input1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-544,1264]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.message_type }}","value2":"incoming"}]}},"id":"3cdf8362-59d7-49a9-b94f-4a955b2b6cb9","name":"Â¿Es del Usuario?1","type":"n8n-nodes-base.if","typeVersion":1,"position":[-336,1264]},{"parameters":{"jsCode":"// ============================================\n// WHATSAPP SAFE RULES - FASE 1\n// ============================================\nconst bot_count = $json.bot_interaction_count || 0;\nconst message_lower = ($json.message_text || '').toLowerCase();\n\n// Regla 1: MÃ¡ximo 1 interacciÃ³n automÃ¡tica en Fase 1\nif (bot_count >= 1) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MAX_INTERACTIONS_PHASE1',\n      escalation_message: 'Te conecto con un agente de inmediato.'\n    }\n  }];\n}\n\n// Regla 2: Mensaje > 24h\nconst message_age_hours = (Date.now() - ($json.message_timestamp * 1000)) / (1000 * 60 * 60);\nif (message_age_hours > 24) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'MESSAGE_TOO_OLD',\n      escalation_message: 'Te conecto con un agente.'\n    }\n  }];\n}\n\n// Regla 3: Horario comercial (Lima, Peru)\nconst now = new Date();\nconst lima_hour = parseInt(now.toLocaleString('en-US', { \n  timeZone: 'America/Lima', \n  hour: 'numeric', \n  hour12: false \n}));\n\nif (lima_hour < 8 || lima_hour >= 22) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'OUTSIDE_BUSINESS_HOURS',\n      escalation_message: 'Gracias por escribirnos. Te responderemos en horario de atenciÃ³n (8am - 10pm).'\n    }\n  }];\n}\n\n// Regla 4: Emergencias\nconst emergency_keywords = [\n  'emergencia', 'urgencia', 'dolor fuerte', 'sangra', 'mucho dolor',\n  'me caÃ­', 'golpe', 'accidente', 'no puedo', 'ayuda urgente',\n  'hinchazÃ³n', 'infecciÃ³n', 'fiebre'\n];\nconst is_emergency = emergency_keywords.some(kw => message_lower.includes(kw));\n\nif (is_emergency) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'EMERGENCY_DETECTED',\n      escalation_message: 'Detecto que podrÃ­as tener una urgencia. Te conecto de inmediato con nuestro equipo.',\n      priority: 'urgent'\n    }\n  }];\n}\n\n// Regla 5: Opt-out\nconst opt_out_keywords = ['detente', 'ya no', 'basta', 'stop', 'cancelar bot', 'agente', 'humano', 'persona'];\nconst wants_opt_out = opt_out_keywords.some(kw => message_lower.includes(kw));\n\nif (wants_opt_out) {\n  return [{\n    json: {\n      ...$json,\n      should_escalate: true,\n      escalation_reason: 'USER_OPT_OUT',\n      escalation_message: 'Entendido. Te conecto con un agente humano.'\n    }\n  }];\n}\n\n// Todo OK - continuar al clasificador\nreturn [{\n  json: {\n    ...$json,\n    should_escalate: false,\n    whatsapp_safe: true,\n    checked_at: new Date().toISOString()\n  }\n}];"},"id":"9555abae-bb52-4416-9999-9353cab32687","name":"WhatsApp Safe Check1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-144,1168]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.should_escalate }}","value2":true}]}},"id":"ee69d2ea-0eef-4770-8d64-ff47feb0c7af","name":"Â¿Escalar Ahora?1","type":"n8n-nodes-base.if","typeVersion":1,"position":[64,1168]},{"parameters":{"promptType":"define","text":"={{ $json.message_text }}","hasOutputParser":true,"options":{"systemMessage":"You are an intent classifier for a dental clinic virtual assistant named SofIA.\nYour ONLY job is to analyze the patient's message and classify it into ONE category.\n\nYou MUST respond with valid JSON in this exact format:\n{\n  \"intent\": \"CREATE_EVENT\" | \"INFO\" | \"PAYMENT\" | \"HUMAN\",\n  \"confidence\": \"high\" | \"medium\" | \"low\"\n}\n\nCLASSIFICATION RULES:\n\n1. CREATE_EVENT\n   Use when: Patient wants to schedule, reschedule, cancel, or ask about appointment availability\n   Keywords: \"cita\", \"agendar\", \"reservar\", \"cambiar\", \"cancelar\", \"disponibilidad\", \"horario\"\n   Examples: \"Quiero una cita\", \"Tienen disponibilidad maÃ±ana?\"\n   \n2. INFO\n   Use when: Patient asks about services, prices, location, general information\n   Keywords: \"cuanto cuesta\", \"donde estÃ¡n\", \"direcciÃ³n\", \"servicios\"\n   Examples: \"CuÃ¡nto cuesta una limpieza?\", \"DÃ³nde estÃ¡n ubicados?\"\n   \n3. PAYMENT\n   Use when: Patient mentions pending payments or asks how to pay\n   Keywords: \"paguÃ©\", \"pago\", \"transferencia\", \"saldo\", \"debo\"\n   Examples: \"Ya paguÃ© mi consulta\", \"CÃ³mo puedo pagar?\"\n   \n4. HUMAN\n   Use when: Medical emergencies, complaints, complex requests\n   Keywords: \"emergencia\", \"urgencia\", \"dolor fuerte\", \"queja\", \"seguro mÃ©dico\"\n   Examples: \"Tengo un dolor terrible\", \"Necesito factura\"\n\nCRITICAL RULES:\n- If message mentions \"emergencia\", \"urgencia\", or \"dolor fuerte\" â†’ ALWAYS return HUMAN with high confidence\n- If ambiguous between CREATE_EVENT and another â†’ choose CREATE_EVENT\n- If greeting without clear intent â†’ return INFO with low confidence\n- If you cannot understand â†’ return HUMAN with low confidence\n- ALWAYS respond with valid JSON, nothing else"}},"id":"c59d2146-da69-418f-8b59-fcf718a85866","name":"Clasificador de IntenciÃ³n1","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[256,1072]},{"parameters":{"model":"gpt-4-turbo-preview","options":{"maxTokens":50,"temperature":0.1}},"id":"dd864953-454b-4093-8b98-9933a5ee6cbc","name":"OpenAI Chat Model1","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[256,1264],"credentials":{"openAiApi":{"id":"SeCPLJI4mV6p2hJR","name":"OpenAi account"}}},{"parameters":{"jsCode":"// ============================================\n// NORMALIZAR OUTPUT DEL CLASIFICADOR\n// ============================================\nlet intent_data = $json.output || $json;\n\nif (typeof intent_data === 'string') {\n  try {\n    intent_data = JSON.parse(intent_data);\n  } catch (e) {\n    const text = intent_data.toLowerCase();\n    if (text.includes('create_event')) {\n      intent_data = { intent: 'CREATE_EVENT', confidence: 'low' };\n    } else if (text.includes('info')) {\n      intent_data = { intent: 'INFO', confidence: 'low' };\n    } else if (text.includes('payment')) {\n      intent_data = { intent: 'PAYMENT', confidence: 'low' };\n    } else {\n      intent_data = { intent: 'HUMAN', confidence: 'low' };\n    }\n  }\n}\n\nlet intent = (intent_data.intent || 'HUMAN').trim().toUpperCase();\nlet confidence = (intent_data.confidence || 'low').toLowerCase();\n\nconst valid_intents = ['CREATE_EVENT', 'INFO', 'PAYMENT', 'HUMAN'];\nif (!valid_intents.includes(intent)) {\n  intent = 'HUMAN';\n  confidence = 'low';\n}\n\nreturn [{\n  json: {\n    ...$json,\n    intent: intent,\n    confidence: confidence,\n    classified_at: new Date().toISOString(),\n    phase: 'PHASE_1_TESTING',\n    action: 'ESCALATE_TO_HUMAN'\n  }\n}];"},"id":"42a0f1e2-1c4a-4881-8c63-0a41e0cd627f","name":"Normalizar Intent1","type":"n8n-nodes-base.code","typeVersion":2,"position":[464,1072]},{"parameters":{"rules":{"rules":[{},{"output":1},{"output":2},{"output":3}]},"fallbackOutput":3},"id":"76537e54-f604-439b-ad31-01ea9ffe9a7f","name":"Router de IntenciÃ³n1","type":"n8n-nodes-base.switch","typeVersion":1,"position":[656,1072]},{"parameters":{"values":{"string":[{"name":"escalation_message_final","value":"={{ $json.escalation_message || 'Te conecto con un agente de nuestro equipo.' }}"},{"name":"escalation_reason_final","value":"={{ $json.escalation_reason || 'PHASE_1_' + $json.intent }}"},{"name":"internal_note","value":"=ðŸ¤– SofIA (Fase 1)\\n\\nIntenciÃ³n detectada: {{ $json.intent }} ({{ $json.confidence }})\\nRazÃ³n: {{ $json.escalation_reason || 'Testing Fase 1' }}\\nMensaje original: \\\"{{ $json.message_text }}\\\"\\nClÃ­nica: {{ $json.clinic_id }}\\nPaciente: {{ $json.patient_id }}"}],"boolean":[{"name":"is_urgent","value":"={{ $json.priority === 'urgent' ? true : false }}"}]},"options":{}},"id":"3500ca67-b461-46e4-a6a0-fe436629bf45","name":"Preparar Escalado1","type":"n8n-nodes-base.set","typeVersion":1,"position":[864,1072]},{"parameters":{"method":"POST","url":"=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"content\": \"{{ $json.escalation_message_final }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}","options":{}},"id":"90129da3-d78a-4434-a9ad-69e8549bd46f","name":"Enviar Mensaje Escalado1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1056,1072]},{"parameters":{"method":"POST","url":"=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"content\": \"{{ $json.internal_note }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": true\n}","options":{}},"id":"242e0a13-d75e-40ec-9ec7-7e7902ac47e8","name":"Crear Nota Interna1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1248,896],"disabled":true},{"parameters":{"method":"PATCH","url":"=https://chat.redsolucionesti.com/api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/custom_attributes","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"yypAwZDH2dV3crfbqJqWCgj1"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"custom_attributes\": {\n    \"bot_handled\": true,\n    \"intent_detected\": \"{{ $json.intent }}\",\n    \"confidence\": \"{{ $json.confidence }}\",\n    \"bot_interaction_count\": {{ ($json.bot_interaction_count || 0) + 1 }},\n    \"last_bot_message_at\": \"{{ $now.toISO() }}\",\n    \"escalation_reason\": \"{{ $json.escalation_reason_final }}\",\n    \"sofia_phase\": \"PHASE_1\"\n  }\n}","options":{}},"id":"3ead72d7-cc5d-4b6c-ba9a-92c930d8aa0b","name":"Actualizar Custom Attributes1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1456,1072]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify({ status: 'ok', processed: true, intent: $json.intent, conversation_id: $json.conversation_id }) }}","options":{"responseCode":200}},"id":"5037f255-a3cb-4780-a30d-b05790fc066a","name":"Responder OK1","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1664,1264]}],"connections":{"Chatwoot Webhook1":{"main":[[{"node":"Validar Input1","type":"main","index":0}]]},"Validar Input1":{"main":[[{"node":"Â¿Es del Usuario?1","type":"main","index":0}]]},"Â¿Es del Usuario?1":{"main":[[{"node":"WhatsApp Safe Check1","type":"main","index":0}],[{"node":"Responder OK1","type":"main","index":0}]]},"WhatsApp Safe Check1":{"main":[[{"node":"Â¿Escalar Ahora?1","type":"main","index":0}]]},"Â¿Escalar Ahora?1":{"main":[[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Clasificador de IntenciÃ³n1","type":"main","index":0}]]},"Clasificador de IntenciÃ³n1":{"main":[[{"node":"Normalizar Intent1","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Clasificador de IntenciÃ³n1","type":"ai_languageModel","index":0}]]},"Normalizar Intent1":{"main":[[{"node":"Router de IntenciÃ³n1","type":"main","index":0}]]},"Router de IntenciÃ³n1":{"main":[[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Preparar Escalado1","type":"main","index":0}],[{"node":"Preparar Escalado1","type":"main","index":0}]]},"Preparar Escalado1":{"main":[[{"node":"Enviar Mensaje Escalado1","type":"main","index":0}]]},"Enviar Mensaje Escalado1":{"main":[[{"node":"Actualizar Custom Attributes1","type":"main","index":0}]]},"Crear Nota Interna1":{"main":[[]]},"Actualizar Custom Attributes1":{"main":[[{"node":"Responder OK1","type":"main","index":0}]]}},"authors":"Gabriel Barrero","name":"Version 65a4b411","description":"","autosaved":true,"workflowPublishHistory":[{"createdAt":"2026-02-09T05:01:47.497Z","id":21,"workflowId":"37SLdWISQLgkHeXk","versionId":"65a4b411-4d31-4a83-8dc5-93681c952193","event":"activated","userId":"d0578bf7-eabc-4d42-8b83-067e0b33b70c"}]}}